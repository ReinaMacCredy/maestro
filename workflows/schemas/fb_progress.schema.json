{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://conductor.dev/schemas/fb_progress.schema.json",
  "title": "File Beads Progress State",
  "description": "State file for tracking beads filing progress with resume capability",
  "type": "object",
  "required": ["trackId", "status"],
  "properties": {
    "trackId": {
      "type": "string",
      "description": "ID of the track (must match directory name)",
      "pattern": "^[a-z0-9-]+_[0-9]{8}$",
      "examples": ["auth-v2_20241223", "bug-fix_20241224"]
    },
    "status": {
      "type": "string",
      "description": "Current beads filing status",
      "enum": ["pending", "in_progress", "complete", "failed"],
      "default": "pending"
    },
    "startedAt": {
      "type": ["string", "null"],
      "description": "ISO 8601 timestamp when filing started",
      "format": "date-time",
      "default": null
    },
    "completedAt": {
      "type": ["string", "null"],
      "description": "ISO 8601 timestamp when filing completed",
      "format": "date-time",
      "default": null
    },
    "threadId": {
      "type": ["string", "null"],
      "description": "Thread ID that started/is running the filing (format: T-uuid)",
      "pattern": "^T-[a-f0-9-]+$",
      "default": null
    },
    "resumeFrom": {
      "type": ["string", "null"],
      "description": "Checkpoint for resuming interrupted filing",
      "enum": ["phase1", "phase2", "phase2_epic_1", "phase2_epic_2", "phase2_epic_3", "phase2_epic_4", "phase2_epic_5", "phase3", "phase3_batch_1", "phase3_batch_2", "phase3_batch_3", "phase4", "phase5", null],
      "default": "phase1"
    },
    "epics": {
      "type": "array",
      "description": "List of created epics",
      "items": {
        "type": "object",
        "required": ["id", "title", "status", "createdAt"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Bead ID (e.g., bd-1)"
          },
          "title": {
            "type": "string",
            "description": "Epic title"
          },
          "status": {
            "type": "string",
            "enum": ["created", "filled", "complete"],
            "description": "Epic creation status"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "When epic was created"
          },
          "reviewed": {
            "type": "boolean",
            "description": "Whether epic has been reviewed",
            "default": false
          },
          "reviewedAt": {
            "type": ["string", "null"],
            "format": "date-time",
            "description": "When epic was reviewed",
            "default": null
          }
        },
        "additionalProperties": false
      },
      "default": []
    },
    "issues": {
      "type": "array",
      "description": "List of created issue IDs (child issues under epics)",
      "items": {
        "type": "string",
        "description": "Bead ID (e.g., bd-4)"
      },
      "default": []
    },
    "crossTrackDeps": {
      "type": "array",
      "description": "Cross-track dependencies that need manual linking",
      "items": {
        "type": "object",
        "required": ["from", "to"],
        "properties": {
          "from": {
            "type": "string",
            "description": "Source bead ID"
          },
          "to": {
            "type": "string",
            "description": "Target track:bead ID (e.g., api_20241223:bd-7)"
          }
        },
        "additionalProperties": false
      },
      "default": []
    },
    "lastBatchCompleted": {
      "type": ["integer", "null"],
      "description": "Last completed batch number (for resume)",
      "minimum": 0,
      "default": null
    },
    "lastError": {
      "type": ["string", "null"],
      "description": "Last error message if status is failed",
      "default": null
    },
    "reviewStatus": {
      "type": ["string", "null"],
      "description": "Review status from rb skill",
      "enum": ["in_progress", "complete", null],
      "default": null
    },
    "reviewStartedAt": {
      "type": ["string", "null"],
      "description": "When review was started",
      "format": "date-time",
      "default": null
    },
    "reviewThreadId": {
      "type": ["string", "null"],
      "description": "Thread ID running the review",
      "pattern": "^T-[a-f0-9-]+$",
      "default": null
    },
    "lastVerified": {
      "type": ["string", "null"],
      "description": "Last verification timestamp for stale detection",
      "format": "date-time",
      "default": null
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "trackId": "auth-v2_20241223",
      "status": "pending",
      "startedAt": null,
      "completedAt": null,
      "threadId": null,
      "resumeFrom": "phase1",
      "epics": [],
      "issues": [],
      "crossTrackDeps": [],
      "lastBatchCompleted": null,
      "lastError": null
    },
    {
      "trackId": "bug-fix_20241224",
      "status": "complete",
      "startedAt": "2024-12-24T09:30:00Z",
      "completedAt": "2024-12-24T09:45:00Z",
      "threadId": "T-019b4cca-03cc-736f-9d83-60a0d36d29af",
      "resumeFrom": null,
      "epics": [
        {
          "id": "bd-1",
          "title": "Epic: Authentication",
          "status": "complete",
          "createdAt": "2024-12-24T09:31:00Z",
          "reviewed": true,
          "reviewedAt": "2024-12-24T10:00:00Z"
        },
        {
          "id": "bd-2",
          "title": "Epic: Database Layer",
          "status": "complete",
          "createdAt": "2024-12-24T09:32:00Z",
          "reviewed": true,
          "reviewedAt": "2024-12-24T10:05:00Z"
        }
      ],
      "issues": ["bd-4", "bd-5", "bd-6", "bd-7", "bd-8"],
      "crossTrackDeps": [
        {"from": "bd-3", "to": "api_20241223:bd-7"}
      ],
      "lastBatchCompleted": 2,
      "lastError": null,
      "reviewStatus": "complete",
      "lastVerified": "2024-12-24T10:10:00Z"
    }
  ]
}
