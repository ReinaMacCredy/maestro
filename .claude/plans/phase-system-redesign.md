# Phase System Redesign - Clean Architecture

_Generated by atlas-prometheus (DIRECT_GENERATE) - Enhanced with Codex findings_

## Context

### Original Request

Redesign the PHASE system for prometheus agent - cleanup all DEPRECATED code and establish cleaner phase names. The current system has accumulated cruft with deprecated phases (INTERVIEW), confusing names (GENERATE vs DIRECT_GENERATE), and duplicate agent files.

### Current Problems

**Phase Name Confusion:**
1. `PHASE: INTERVIEW` - deprecated but still documented
2. `PHASE: GENERATE` - rarely used, unclear purpose
3. `PHASE: DIRECT_GENERATE` - preferred but awkward name
4. `PHASE: FIX` - unclear what's being fixed
5. `PHASE: CODEX` - only used for Codex enhancement
6. `PHASE: REVIEW_CODEX_ENHANCEMENT` - only in command file, nowhere else

**File Duplication:**
- `skills/atlas/references/agents/atlas-prometheus.md` (canonical, 1899 lines)
- `.claude/skills/atlas/references/agents/atlas-prometheus.md` (duplicate, 1899 lines)
- `.claude/agents/prometheus.md` (old sisyphus naming, 1899 lines)
- Symlink: `.claude/agents/atlas-prometheus.md` → canonical (correct pattern)

**Documentation Drift:**
- Hook architecture docs reference old phase names
- Codex handoffs contain outdated guidance about keeping INTERVIEW
- Pipeline state machine uses inconsistent phase names

### Design Decisions

**New Phase System** (cleaner, self-explanatory):
- `GENERATE` (was DIRECT_GENERATE) - Default plan generation mode
- `REVISE` (was FIX) - Revise plan after Momus rejection
- `ENHANCE` (was CODEX/REVIEW_CODEX_ENHANCEMENT) - Review Codex enhancement

**Rationale:**
- `GENERATE` is shorter, clearer than DIRECT_GENERATE
- `REVISE` is semantically accurate (revising based on feedback)
- `ENHANCE` clearly indicates Codex enhancement step
- No INTERVIEW phase - main context handles this

**Phase Name Mapping:**

| Old State File Phase | New State File Phase | Old Agent Prompt Phase | New Agent Prompt Phase |
|---------------------|----------------------|------------------------|------------------------|
| PLAN_GENERATE | PLAN_GENERATE (unchanged) | PHASE: GENERATE | PHASE: GENERATE (unchanged) |
| DIRECT_GENERATE | GENERATE | PHASE: DIRECT_GENERATE | PHASE: GENERATE |
| PROMETHEUS_FIX | PROMETHEUS_REVISE | PHASE: FIX | PHASE: REVISE |
| CODEX_GENERATE | CODEX_ENHANCE | PHASE: CODEX | PHASE: ENHANCE |

**Note:** State file phases use different naming than agent prompt phases. This table clarifies both contexts.

**File Consolidation Strategy:**
1. Keep canonical: `skills/atlas/references/agents/atlas-prometheus.md`
2. Keep symlink: `.claude/agents/atlas-prometheus.md` → canonical
3. Delete duplicate: `.claude/skills/atlas/references/agents/atlas-prometheus.md`
4. Delete old naming: `.claude/agents/prometheus.md`

**Historical Docs Exemption:**
The following historical/archived documents will NOT be updated (per user decision):
- `.claude/plans/atlas-plan-optimization.md`
- `.atlas/codex/results/*.md` (Codex output archives)
- `thoughts/` directory (if exists)
- Any files in `.atlas/backups/`

---

## Work Objectives

### Core Objective

Refactor the prometheus agent phase system to use clearer phase names (GENERATE, REVISE, ENHANCE), remove all deprecated INTERVIEW code, consolidate duplicate agent files, and update all documentation to reflect the new architecture.

### Concrete Deliverables

1. **Updated Schema**: `scripts/lib/state_schema.json` with new phase enum values
2. **Updated Agent File**: `skills/atlas/references/agents/atlas-prometheus.md` with new phase system
3. **Updated State Machine**: `scripts/lib/pipeline-state-machine.sh` with exact line updates
4. **Updated Tests**: All test files using new phase names
5. **Cleaned Documentation**: All phase references in docs updated (HOOK_ARCHITECTURE.md, etc.)
6. **Updated Hook Scripts**: All phase transitions use new names
7. **Deleted Files**: Remove duplicate prometheus agent files
8. **Updated Command Files**: `.claude/commands/atlas-plan.md` reflects new phases
9. **Cleaned Handoffs**: Remove outdated guidance from `.atlas/codex/handoffs/`
10. **Runtime Validation**: End-to-end test of new phase system
11. **.gitignore Update**: Add `.atlas/backups/` to prevent accidental commits

### Definition of Done

- [ ] Schema updated with new phase enum values - `rg "GENERATE|PROMETHEUS_REVISE|CODEX_ENHANCE" scripts/lib/state_schema.json`
- [ ] All references to `PHASE.*INTERVIEW` removed from codebase - `! rg "PHASE.*INTERVIEW" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] All references to `DIRECT_GENERATE` replaced with `GENERATE` - `! rg "DIRECT_GENERATE" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] All references to `PHASE.*FIX` replaced with `REVISE` - `! rg "PHASE.*FIX" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] All references to `PHASE.*CODEX` replaced with `ENHANCE` - `! rg "PHASE.*CODEX" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] Only one canonical prometheus agent file exists (+ symlink)
- [ ] All hooks use new phase names consistently
- [ ] Documentation accurately describes new phase system
- [ ] No broken references to deleted files
- [ ] Runtime smoke test passes with new phase names
- [ ] `.atlas/backups/` added to .gitignore

### Must Have

- Complete removal of INTERVIEW phase logic and error handling
- Schema migration for state file phase enums
- Consistent use of new phase names across all files
- File consolidation (no duplicates except symlinks)
- Updated hook scripts that reference phases
- Updated test files with new phase names
- Symlink resolution verification
- Runtime end-to-end smoke test
- Clear migration guide for any external dependencies
- Backup of pipeline-state.json before deletion
- `.atlas/backups/` in .gitignore

### Must NOT Have (Guardrails)

- DO NOT modify CLAUDE.md (user explicitly excluded)
- DO NOT change execution workflow (atlas-work, orchestrator)
- DO NOT alter other agent files (metis, momus, etc.) unless they reference old phase names
- DO NOT change the phase system behavior - only rename for clarity
- DO NOT break backward compatibility for hooks reading pipeline-state.json
- DO NOT skip comprehensive validation before considering this complete
- DO NOT update historical/archived docs (see exemption list above)

---

## Prerequisites

### Dependencies

- `bash` 4.0+ (for hook scripts)
- `jq` 1.6+ (for JSON manipulation in hooks)
- `ripgrep` (for validation commands)
- `pytest` (for running tests after changes)

### Required Knowledge

- Understanding of Atlas pipeline flow (interview → plan → metis → momus)
- Familiarity with Claude Code hook system
- Knowledge of JSON state file structure (pipeline-state.json)
- Understanding of agent spawn patterns via Task tool
- JSON Schema validation for state files

### Environment Setup

```bash
# Verify tools
which rg jq bash python3

# Backup pipeline state BEFORE clearing (Codex finding - HIGH priority)
mkdir -p .atlas/backups/phase-redesign
cp .atlas/pipeline-state.json .atlas/backups/phase-redesign/ 2>/dev/null || true

# Clear pipeline state (user decision)
rm .atlas/pipeline-state.json 2>/dev/null || true

# Create backup before changes
cp -r skills/atlas/references/agents/ .atlas/backups/phase-redesign/
cp -r .claude/agents/ .atlas/backups/phase-redesign/
cp -r scripts/ .atlas/backups/phase-redesign/
cp scripts/lib/state_schema.json .atlas/backups/phase-redesign/

# Verify current state
rg "PHASE:" --type md -c | head -20
```

---

## Verification Strategy

### Test Decision

- **Infrastructure exists**: YES (pytest framework in tests/)
- **User wants tests**: Manual verification (high-risk refactor mode)
- **Framework**: pytest + bash validation
- **Coverage Goals**: Verify all file references, no broken links, runtime correctness

### Manual Verification

Each task includes verification procedures:

| Type | Verification | Procedure |
|------|-------------|-----------|
| **Agent File** | Text search + spawn test | grep for old phases, spawn agent with new phase |
| **Hook Scripts** | Bash syntax + state machine | shellcheck, test state transitions |
| **Documentation** | Link validation | Check all file paths exist, no 404s |
| **Runtime** | End-to-end smoke test | Spawn prometheus with PHASE: GENERATE, verify workflow |

---

## Task Flow

```
Task 1 (Backup & Clear State) → Task 1.5 (Schema Migration)
                                      ↓
                                Task 2 (Define new phases in agent)
                                      ↓
                                Task 3 (Update hook scripts + ALL tests)
                                      ↓
                                Task 4 (Update documentation) [parallel with Task 6]
                                      ↓
                                Task 5 (Consolidate files) → Task 5.5 (Symlink resolution test)
                                      ↓
                                Task 6 (Clean handoffs) [parallel with Task 4]
                                      ↓
                                Task 7 (Validation) → Task 7.5 (Runtime smoke test)
```

## Parallelization

| Group | Tasks | Reason |
|-------|-------|--------|
| A | 4, 6 | Independent files after Task 3 complete (Task 3 must finish before parallelization) |

---

## TODOs

### Task 1: Create Backup, Clear Pipeline State, and Audit Current State

**What to do:**
- Create timestamped backup directory
- **BACKUP pipeline-state.json FIRST** (Codex finding - prevents state loss)
- Copy all affected files to backup (agents, scripts, docs, schema)
- Clear pipeline state: `rm .atlas/pipeline-state.json` (user decision)
- Generate audit report of current phase usage
- Document all files containing phase references
- Find all docs with phase references: `rg 'PHASE.*:' docs/ --type md -l`
- **Add `.atlas/backups/` to .gitignore** (Codex finding - prevent accidental commits)

**Must NOT do:**
- Don't proceed without backup
- Don't skip audit report (need baseline)
- Don't skip clearing pipeline state
- Don't delete pipeline-state.json before backing it up

**Complexity**: 2/10
**Location**: `.atlas/backups/phase-redesign-{timestamp}/` (new directory), `.gitignore`
**Dependencies**: None
**Parallelizable**: NO (foundation for all other tasks)

**Manual Verification:**
- Step 1: Run `ls -la .atlas/backups/phase-redesign-*/`
- Step 2: Verify all key files backed up
- Step 3: Verify pipeline state cleared - `[ ! -f .atlas/pipeline-state.json ]`
- Step 4: Check .gitignore - `grep ".atlas/backups" .gitignore`
- Expected: Backup directory with agent files, scripts, docs, schema, pipeline-state.json; state cleared; .gitignore updated

**Acceptance Criteria:**
- [ ] Backup directory created with timestamp - `ls .atlas/backups/`
- [ ] Pipeline state backed up FIRST - `ls .atlas/backups/phase-redesign-*/pipeline-state.json`
- [ ] All agent files backed up - `ls .atlas/backups/phase-redesign-*/agents/`
- [ ] All hook scripts backed up - `ls .atlas/backups/phase-redesign-*/scripts/`
- [ ] Schema backed up - `ls .atlas/backups/phase-redesign-*/state_schema.json`
- [ ] Pipeline state cleared - `[ ! -f .atlas/pipeline-state.json ]`
- [ ] `.atlas/backups/` in .gitignore - `grep ".atlas/backups" .gitignore`
- [ ] Audit report generated - `cat .atlas/backups/phase-redesign-*/AUDIT.md`
- [ ] Audit lists all files with PHASE references - `grep "PHASE" .atlas/backups/phase-redesign-*/AUDIT.md`
- [ ] Audit includes docs with phase refs - `grep "docs/" .atlas/backups/phase-redesign-*/AUDIT.md`

**Commit**: YES
- Message: `chore(atlas): prepare for phase system redesign (backup + gitignore update)`
- Files: `.gitignore`

**Rollback Strategy:**
```bash
# Restore from backup if needed
cp -r .atlas/backups/phase-redesign-{timestamp}/* ./
```

---

### Task 1.5: Update State Schema with New Phase Enum Values

**What to do:**
- Open `scripts/lib/state_schema.json`
- Update the `current_phase` enum in the schema (lines 12-26):
  - **REMOVE INTERVIEW from enum** (line 15) - user chose "aggressive cleanup"
  - Rename `DIRECT_GENERATE` → `GENERATE` (line 19)
  - Rename `CODEX_GENERATE` → `CODEX_ENHANCE` (line 18)
  - Rename `PROMETHEUS_FIX` → `PROMETHEUS_REVISE` (line 23)
- **Complete list of changes to enum array:**
  - Keep: `IDLE`, `PLANNING`, `GAP_ANALYSIS`, `PLAN_GENERATE`, `CHOICE_POINT`, `PLAN_READY`, `MOMUS_REVIEW`, `COMPLETE`, `MANUAL_REVIEW`
  - DELETE: `INTERVIEW` (line 15)
  - RENAME: `CODEX_GENERATE` → `CODEX_ENHANCE` (line 18)
  - RENAME: `DIRECT_GENERATE` → `GENERATE` (line 19)
  - RENAME: `PROMETHEUS_FIX` → `PROMETHEUS_REVISE` (line 23)
- **Final expected enum array (after all changes):**
  ```json
  "enum": [
    "IDLE",
    "PLANNING",
    "GAP_ANALYSIS",
    "PLAN_GENERATE",
    "CODEX_ENHANCE",
    "GENERATE",
    "CHOICE_POINT",
    "PLAN_READY",
    "MOMUS_REVIEW",
    "PROMETHEUS_REVISE",
    "COMPLETE",
    "MANUAL_REVIEW"
  ]
  ```
- Validate JSON syntax: `jq empty scripts/lib/state_schema.json`
- Run schema validation tests

**Must NOT do:**
- Don't change schema structure, only enum values
- Don't remove any other phase names (PLAN_GENERATE, etc.)
- Don't alter property definitions

**Complexity**: 3/10
**Location**: `scripts/lib/state_schema.json:12-26` (enum definition section)
**Dependencies**: Task 1 (backup complete, state cleared)
**Parallelizable**: NO (required before Task 2)

**Manual Verification:**
- Step 1: Validate JSON - `jq empty scripts/lib/state_schema.json`
- Step 2: Check new enum values - `jq '.properties.current_phase.enum' scripts/lib/state_schema.json`
- Step 3: Verify INTERVIEW removed - `! rg "INTERVIEW" scripts/lib/state_schema.json`
- Step 4: Run schema tests - `pytest tests/unit/test_state_validate.py::test_schema_valid -v`
- Expected: Valid JSON, new phase names in enum, INTERVIEW gone, tests pass

**References:**

**Pattern References:**
- Current schema structure in `scripts/lib/state_schema.json`

**Test References:**
- `tests/unit/test_state_validate.py` - Schema validation tests

**Acceptance Criteria:**
- [ ] Schema JSON valid - `jq empty scripts/lib/state_schema.json`
- [ ] INTERVIEW removed from enum - `! rg "INTERVIEW" scripts/lib/state_schema.json`
- [ ] GENERATE in enum - `jq '.properties.current_phase.enum | contains(["GENERATE"])' scripts/lib/state_schema.json`
- [ ] PROMETHEUS_REVISE in enum - `jq '.properties.current_phase.enum | contains(["PROMETHEUS_REVISE"])' scripts/lib/state_schema.json`
- [ ] CODEX_ENHANCE in enum - `jq '.properties.current_phase.enum | contains(["CODEX_ENHANCE"])' scripts/lib/state_schema.json`
- [ ] Old values removed - `! rg "DIRECT_GENERATE|PROMETHEUS_FIX|CODEX_GENERATE" scripts/lib/state_schema.json`
- [ ] Schema tests pass - `pytest tests/unit/test_state_validate.py::test_schema_valid -v`

**Commit**: YES
- Message: `refactor(schema): update phase enum values (remove INTERVIEW, rename to GENERATE/PROMETHEUS_REVISE/CODEX_ENHANCE)`
- Files: `scripts/lib/state_schema.json`

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Or restore from backup
cp .atlas/backups/phase-redesign-*/state_schema.json scripts/lib/
```

---

### Task 2: Update Canonical Prometheus Agent with New Phase System

**What to do:**
- Open `skills/atlas/references/agents/atlas-prometheus.md`
- Replace all phase documentation with new clean system:
  - Remove entire "PHASE: INTERVIEW (DEPRECATED)" section
  - Rename "PHASE: DIRECT_GENERATE" → "PHASE: GENERATE"
  - Rename "PHASE: FIX" → "PHASE: REVISE"
  - Rename "PHASE: CODEX" → "PHASE: ENHANCE"
  - Remove "PHASE: GENERATE" (old, rarely used)
- Update "Structured Output Format" section with new phase names
- Update all references to phase names in examples
- Update "Phase-Based Operation" section to list only 3 phases
- Update "Required Prompt Format" examples to use `PHASE: GENERATE`
- Remove deprecated interview error handling code
- Update all internal cross-references

**Must NOT do:**
- Don't change behavior, only rename phases
- Don't alter the YAML frontmatter
- Don't modify the plan template structure
- Don't change Codex handoff format

**Complexity**: 7/10
**Location**: `skills/atlas/references/agents/atlas-prometheus.md:1-1899`
**Dependencies**: Task 1.5 (schema updated with new phase names)
**Parallelizable**: NO (foundation for other file updates)

**Manual Verification:**
- Step 1: Search for old phase names - `rg "INTERVIEW|DIRECT_GENERATE|PHASE.*FIX" skills/atlas/references/agents/atlas-prometheus.md`
- Step 2: Verify new phase names present - `rg "PHASE: (GENERATE|REVISE|ENHANCE)" skills/atlas/references/agents/atlas-prometheus.md`
- Step 3: Check structure intact - `head -20 skills/atlas/references/agents/atlas-prometheus.md`
- Expected: No old phase names, new phases documented clearly

**References:**

**Pattern References:**
- Current file structure (sections: Critical Identity, Structured Output Format, Phase-Based Operation, etc.)
- JSON output examples for each phase

**Acceptance Criteria:**
- [ ] All "PHASE: INTERVIEW" text removed - `! rg "INTERVIEW" skills/atlas/references/agents/atlas-prometheus.md`
- [ ] All "DIRECT_GENERATE" replaced with "GENERATE" - `! rg "DIRECT_GENERATE" skills/atlas/references/agents/atlas-prometheus.md`
- [ ] All "PHASE: FIX" replaced with "PHASE: REVISE" - `rg "PHASE: REVISE" skills/atlas/references/agents/atlas-prometheus.md`
- [ ] All "PHASE: CODEX" replaced with "PHASE: ENHANCE" - `rg "PHASE: ENHANCE" skills/atlas/references/agents/atlas-prometheus.md`
- [ ] YAML frontmatter unchanged - `head -10 skills/atlas/references/agents/atlas-prometheus.md | grep "name: atlas-prometheus"`
- [ ] Three phases documented: GENERATE, REVISE, ENHANCE - `rg "### PHASE:" skills/atlas/references/agents/atlas-prometheus.md | wc -l` (expect 3)

**Commit**: YES
- Message: `refactor(atlas): redesign prometheus phase system (GENERATE, REVISE, ENHANCE)`
- Files: `skills/atlas/references/agents/atlas-prometheus.md`

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Or restore from backup
cp .atlas/backups/phase-redesign-*/agents/atlas-prometheus.md skills/atlas/references/agents/
```

---

### Task 3: Update Hook Scripts, State Machine, and ALL Test Files with New Phase Names

**What to do:**
- Update `scripts/plan-ready-handler.sh`:
  - Replace phase references to use GENERATE instead of DIRECT_GENERATE
  - Update comments and error messages
- Update `scripts/momus-loop-handler.sh`:
  - Replace "PHASE: FIX" → "PHASE: REVISE" in spawn instructions
  - Update pipeline state transitions
- Update `scripts/codex-completion-handler.sh`:
  - Replace "PHASE: CODEX" → "PHASE: ENHANCE"
- **Update `scripts/keyword-detector.sh`** (Codex finding - line 169):
  - Update any phase references in keyword detection logic
- **Update `scripts/pipeline-transition.sh`** (Codex finding - lines 1-12):
  - Replace old phase names (INTERVIEW, PROMETHEUS_FIX) with new ones
- **Update `scripts/lib/pipeline-state-machine.sh` (EXACT line updates):**
  - Line 128: DELETE or replace `INTERVIEW)` case (Codex finding - missing from original plan)
  - Line 157: `PLAN_GENERATE|CODEX_GENERATE|DIRECT_GENERATE` → `PLAN_GENERATE|CODEX_ENHANCE|GENERATE`
  - Line 199: `PROMETHEUS_FIX` → `PROMETHEUS_REVISE`
  - Line 243: `CODEX_GENERATE` → `CODEX_ENHANCE`
  - Line 343: `PROMETHEUS_FIX` → `PROMETHEUS_REVISE`
  - Line 353: `PHASE: FIX` → `PHASE: REVISE`
- Update `scripts/generator-choice-handler.sh`:
  - Replace PLAN_GENERATE references if needed
- **Update `tests/unit/test_state_validate.py`:**
  - **Update `test_all_valid_phases` method (lines 99-115):**
    - REMOVE `"INTERVIEW"` from valid_phases list (line 104)
    - REPLACE `"CODEX_GENERATE"` with `"CODEX_ENHANCE"` (line 107)
    - REPLACE `"DIRECT_GENERATE"` with `"GENERATE"` (line 108)
    - REPLACE `"PROMETHEUS_FIX"` with `"PROMETHEUS_REVISE"` (line 112)
  - **Update other test methods with specific replacement values:**
    - `test_valid_state_passes` (line 23): Replace `"INTERVIEW"` with `"PLANNING"` (context: initial planning state)
    - `test_missing_version_repaired` (line 39): Replace `"INTERVIEW"` with `"IDLE"` (context: default state)
    - `test_legacy_stage_migrated_to_phase` (lines 50, 54): Replace both `"INTERVIEW"` with `"PLANNING"` (context: migration from old stage system)
    - `test_wrong_version_type_errors` (line 81): Replace `"INTERVIEW"` with `"IDLE"` (context: default initialization)
    - `test_negative_momus_iterations_errors` (line 91): Replace `"INTERVIEW"` with `"IDLE"` (context: default state for error test)
  - **Pattern**: Use `IDLE` for default/initialization contexts, `PLANNING` for active planning contexts
  - Verify tests pass after update
- **Update `tests/integration/test_hooks.py:170`** (Codex finding - additional test file):
  - Replace old phase names with new ones
- **Update `tests/unit/test_state_recover.py:67`** (Codex finding - additional test file):
  - Replace old phase names with new ones
- **Update `tests/unit/test_diagnose.py:63`** (Codex finding - additional test file):
  - Replace old phase names with new ones
- Check all other scripts for phase references:
  - `rg "PHASE.*:" scripts/ --type sh`

**Must NOT do:**
- Don't change hook logic, only rename phases
- Don't alter JSON schema structure
- Don't modify error handling behavior
- Don't change state transition flow
- Don't skip ANY test file updates

**Complexity**: 8/10 (increased from 7 due to additional files)
**Location**: `scripts/*.sh`, `scripts/lib/pipeline-state-machine.sh:128,157,199,243,343,353`, `tests/unit/test_state_validate.py:23-115`, `tests/integration/test_hooks.py:170`, `tests/unit/test_state_recover.py:67`, `tests/unit/test_diagnose.py:63`
**Dependencies**: Task 2 (agent file updated with new phase names)
**Parallelizable**: NO (must complete before Task 4, 6 can run in parallel)

**Manual Verification:**
- Step 1: Search for old phase names - `rg "DIRECT_GENERATE|PHASE.*FIX|PHASE.*CODEX|INTERVIEW" scripts/ tests/`
- Step 2: Verify state machine lines updated - `sed -n '128p;157p;199p;243p;343p;353p' scripts/lib/pipeline-state-machine.sh | grep -E "GENERATE|PROMETHEUS_REVISE|CODEX_ENHANCE"`
- Step 3: Test state machine - `bash scripts/lib/pipeline-state-machine.sh test` (if test mode exists)
- Step 4: Validate JSON output - `jq empty .atlas/pipeline-state.json` (after recreation)
- Step 5: Run ALL updated tests - `pytest tests/ -v`
- Expected: All hooks use new phase names, state machine valid, ALL tests pass

**References:**

**Pattern References:**
- `scripts/lib/hook-common.sh` - Common hook patterns
- Current state machine transition table

**Test References:**
- `tests/unit/test_state_validate.py` - State validation tests (must be updated)
- `tests/integration/test_hooks.py` - Hook integration tests (must be updated)
- `tests/unit/test_state_recover.py` - State recovery tests (must be updated)
- `tests/unit/test_diagnose.py` - Diagnostic tests (must be updated)

**Acceptance Criteria:**
- [ ] No "DIRECT_GENERATE" in hook scripts - `! rg "DIRECT_GENERATE" scripts/ --type sh`
- [ ] No "INTERVIEW" in test files - `! rg "INTERVIEW" tests/`
- [ ] "PHASE: REVISE" used instead of "PHASE: FIX" - `rg "PHASE: REVISE" scripts/momus-loop-handler.sh`
- [ ] "PHASE: ENHANCE" used instead of "PHASE: CODEX" - `rg "PHASE: ENHANCE" scripts/codex-completion-handler.sh`
- [ ] Line 128 updated/deleted - `! sed -n '128p' scripts/lib/pipeline-state-machine.sh | grep "INTERVIEW)"`
- [ ] Line 157 updated - `sed -n '157p' scripts/lib/pipeline-state-machine.sh | grep "PLAN_GENERATE|CODEX_ENHANCE|GENERATE"`
- [ ] Line 199 updated - `sed -n '199p' scripts/lib/pipeline-state-machine.sh | grep "PROMETHEUS_REVISE"`
- [ ] Line 243 updated - `sed -n '243p' scripts/lib/pipeline-state-machine.sh | grep "CODEX_ENHANCE"`
- [ ] Line 343 updated - `sed -n '343p' scripts/lib/pipeline-state-machine.sh | grep "PROMETHEUS_REVISE"`
- [ ] Line 353 updated - `sed -n '353p' scripts/lib/pipeline-state-machine.sh | grep "PHASE: REVISE"`
- [ ] keyword-detector.sh updated - `! rg "INTERVIEW|DIRECT_GENERATE" scripts/keyword-detector.sh`
- [ ] pipeline-transition.sh updated - `! rg "INTERVIEW|PROMETHEUS_FIX" scripts/pipeline-transition.sh`
- [ ] Test file updated - `rg "GENERATE|PROMETHEUS_REVISE|CODEX_ENHANCE" tests/unit/test_state_validate.py`
- [ ] Integration test updated - `! rg "INTERVIEW" tests/integration/test_hooks.py`
- [ ] State recover test updated - `! rg "INTERVIEW" tests/unit/test_state_recover.py`
- [ ] Diagnose test updated - `! rg "INTERVIEW" tests/unit/test_diagnose.py`
- [ ] State validation tests pass - `pytest tests/unit/test_state_validate.py -v`
- [ ] ALL tests pass - `pytest tests/ -v`
- [ ] All scripts pass shellcheck - `find scripts -name '*.sh' -exec shellcheck {} \;`

**Commit**: YES
- Message: `refactor(hooks): update phase names to GENERATE/REVISE/ENHANCE (includes state machine and ALL tests)`
- Files: `scripts/plan-ready-handler.sh`, `scripts/momus-loop-handler.sh`, `scripts/codex-completion-handler.sh`, `scripts/keyword-detector.sh`, `scripts/pipeline-transition.sh`, `scripts/lib/pipeline-state-machine.sh`, `scripts/generator-choice-handler.sh`, `tests/unit/test_state_validate.py`, `tests/integration/test_hooks.py`, `tests/unit/test_state_recover.py`, `tests/unit/test_diagnose.py`

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Or restore from backup
cp .atlas/backups/phase-redesign-*/scripts/*.sh scripts/
cp .atlas/backups/phase-redesign-*/scripts/lib/*.sh scripts/lib/
cp .atlas/backups/phase-redesign-*/tests/unit/*.py tests/unit/
cp .atlas/backups/phase-redesign-*/tests/integration/*.py tests/integration/
```

---

### Task 4: Update Documentation Files

**What to do:**
- Update `docs/HOOK_ARCHITECTURE.md`:
  - Replace all phase name references (GENERATE, REVISE, ENHANCE)
  - Update state machine diagrams (lines 228-240, 453-460, 519-531, 735-741)
  - Update example spawn commands (line 738, 860)
  - Fix any references to deprecated INTERVIEW phase
- Update `.claude/commands/atlas-plan.md`:
  - Update PHASE references in spawn examples
  - Remove any INTERVIEW phase guidance
  - Update pipeline flow diagram
- **Update `hooks/AGENTS.md:138`** (Codex finding):
  - Replace old phase references
- **Update `docs/AGENTS.md:268`** (Codex finding):
  - Replace old phase references
- **Update `skills/atlas/SKILL.md:206`** (Codex finding):
  - Replace old phase references
- **Update `skills/atlas/references/workflows/prometheus.md:122`** (Codex finding):
  - Replace old phase references
- **Update `.claude/commands/AGENTS.md:47`** (Codex finding):
  - Replace old phase references
- **Update `tests/AGENTS.md:120`** (Codex finding):
  - Replace old phase references
- **Find and update ALL docs with phase references** (from Task 1 audit):
  - Use audit report from Task 1 to identify all documentation files
  - `rg 'PHASE.*:' docs/ --type md -l` (cross-reference with audit)
  - `docs/HOOK_ARCHITECTURE.md` (confirmed)
  - `docs/STATE_MANAGEMENT.md` (if it exists and has phase refs)
  - `docs/ATLAS_AGENTS.md` (if it exists and has phase refs)
  - `.claude/commands/atlas-plan.md` (confirmed)
  - Any other files listed in Task 1 audit report
  - Update any remaining old phase references
- **SKIP historical/archived docs** (exemption list):
  - `.claude/plans/atlas-plan-optimization.md`
  - `.atlas/codex/results/*.md`
  - `thoughts/` directory
- **List all updated docs explicitly in commit message**

**Must NOT do:**
- Don't modify CLAUDE.md (user exclusion)
- Don't change hook architecture concepts, only naming
- Don't alter workflow behavior descriptions
- Don't update historical/archived docs (see exemption list)

**Complexity**: 6/10 (increased from 5 due to additional files)
**Location**: `docs/HOOK_ARCHITECTURE.md`, `.claude/commands/atlas-plan.md`, `hooks/AGENTS.md:138`, `docs/AGENTS.md:268`, `skills/atlas/SKILL.md:206`, `skills/atlas/references/workflows/prometheus.md:122`, `.claude/commands/AGENTS.md:47`, `tests/AGENTS.md:120`, (all docs from Task 1 audit)
**Dependencies**: Task 3 (hooks and state machine updated)
**Parallelizable**: YES (independent from Task 6 after Task 3)

**Manual Verification:**
- Step 1: Search for old phase names - `rg "DIRECT_GENERATE|PHASE.*FIX|PHASE.*CODEX" docs/ .claude/commands/ hooks/ skills/ tests/ -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- Step 2: Verify new phase names - `rg "PHASE: (GENERATE|REVISE|ENHANCE)" docs/`
- Step 3: Check for broken links - `grep -r "\.md" docs/ | grep -v "^Binary"`
- Expected: All docs use new phase names, no broken references

**References:**

**Pattern References:**
- Current hook architecture doc structure
- Existing state machine diagrams (ASCII art)

**Acceptance Criteria:**
- [ ] No "DIRECT_GENERATE" in docs - `! rg "DIRECT_GENERATE" docs/ .claude/commands/ hooks/ skills/ tests/ -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] State machine diagrams updated - `rg "PLAN_GENERATE|PROMETHEUS_FIX|CODEX_GENERATE" docs/HOOK_ARCHITECTURE.md | wc -l` (expect 0)
- [ ] New phase names in examples - `rg "PHASE: (GENERATE|REVISE|ENHANCE)" docs/HOOK_ARCHITECTURE.md`
- [ ] No INTERVIEW references - `! rg "PHASE.*INTERVIEW" docs/ -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*'`
- [ ] hooks/AGENTS.md:138 updated - `! rg "INTERVIEW|DIRECT_GENERATE" hooks/AGENTS.md`
- [ ] docs/AGENTS.md:268 updated - `! rg "INTERVIEW|DIRECT_GENERATE" docs/AGENTS.md`
- [ ] skills/atlas/SKILL.md:206 updated - `! rg "INTERVIEW|DIRECT_GENERATE" skills/atlas/SKILL.md`
- [ ] prometheus.md workflow updated - `! rg "INTERVIEW|DIRECT_GENERATE" skills/atlas/references/workflows/prometheus.md`
- [ ] .claude/commands/AGENTS.md:47 updated - `! rg "INTERVIEW|DIRECT_GENERATE" .claude/commands/AGENTS.md`
- [ ] tests/AGENTS.md:120 updated - `! rg "INTERVIEW|DIRECT_GENERATE" tests/AGENTS.md`
- [ ] All file references valid - `for f in $(rg -o '\.\w+/[^)]+\.md' docs/ -r '$0' --no-filename); do [ -f "$f" ] || echo "BROKEN: $f"; done`
- [ ] Audit report cross-referenced - all files from Task 1 audit updated (except exemptions)

**Commit**: YES
- Message: `docs(atlas): update phase system documentation (GENERATE/REVISE/ENHANCE) - updated: HOOK_ARCHITECTURE.md, atlas-plan.md, hooks/AGENTS.md, docs/AGENTS.md, skills/atlas/SKILL.md, prometheus.md, .claude/commands/AGENTS.md, tests/AGENTS.md`
- Files: `docs/HOOK_ARCHITECTURE.md`, `.claude/commands/atlas-plan.md`, `hooks/AGENTS.md`, `docs/AGENTS.md`, `skills/atlas/SKILL.md`, `skills/atlas/references/workflows/prometheus.md`, `.claude/commands/AGENTS.md`, `tests/AGENTS.md`

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Or restore from backup
cp .atlas/backups/phase-redesign-*/docs/* docs/
cp .atlas/backups/phase-redesign-*/commands/* .claude/commands/
```

---

### Task 5: Consolidate Duplicate Prometheus Files

**What to do:**
- Verify canonical file: `skills/atlas/references/agents/atlas-prometheus.md` (updated in Task 2)
- Verify symlink exists and is correct: `.claude/agents/atlas-prometheus.md` → `../../skills/atlas/references/agents/atlas-prometheus.md`
- Delete duplicate: `.claude/skills/atlas/references/agents/atlas-prometheus.md`
- Delete old naming: `.claude/agents/prometheus.md`
- Update any references to deleted file paths in documentation
- Verify symlink resolves correctly after deletion

**Must NOT do:**
- Don't delete the canonical file
- Don't remove the symlink
- Don't leave broken references

**Complexity**: 3/10
**Location**: `.claude/agents/`, `.claude/skills/atlas/references/agents/`
**Dependencies**: Task 2 (canonical file updated and verified)
**Parallelizable**: NO (must happen after Task 2, before Task 5.5)

**Manual Verification:**
- Step 1: Verify canonical exists - `ls -la skills/atlas/references/agents/atlas-prometheus.md`
- Step 2: Verify symlink - `ls -la .claude/agents/atlas-prometheus.md`
- Step 3: Verify duplicates gone - `! ls .claude/agents/prometheus.md .claude/skills/atlas/references/agents/atlas-prometheus.md 2>/dev/null`
- Step 4: Test symlink resolution - `cat .claude/agents/atlas-prometheus.md | head -5`
- Expected: Canonical exists, symlink works, duplicates deleted

**References:**

**Pattern References:**
- Existing symlink structure for other atlas agents

**Acceptance Criteria:**
- [ ] Canonical file exists and updated - `[ -f skills/atlas/references/agents/atlas-prometheus.md ]`
- [ ] Symlink exists and valid - `[ -L .claude/agents/atlas-prometheus.md ] && readlink .claude/agents/atlas-prometheus.md`
- [ ] Old duplicate deleted - `[ ! -f .claude/skills/atlas/references/agents/atlas-prometheus.md ]`
- [ ] Old naming deleted - `[ ! -f .claude/agents/prometheus.md ]`
- [ ] Symlink resolves correctly - `cat .claude/agents/atlas-prometheus.md | grep "atlas-prometheus" | head -1`
- [ ] No broken references in docs - `! rg "\.claude/agents/prometheus\.md|\.claude/skills/atlas" docs/`

**Commit**: YES
- Message: `refactor(atlas): consolidate prometheus agent files (remove duplicates)`
- Files: `.claude/agents/prometheus.md` (delete), `.claude/skills/atlas/references/agents/atlas-prometheus.md` (delete)

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Files will be restored from git history
```

---

### Task 5.5: Test Symlink Resolution for Agent Spawning

**What to do:**
- Create a test script that spawns atlas-prometheus via symlink path
- Test spawning with: `.claude/agents/atlas-prometheus.md`
- Verify agent loads correctly (YAML frontmatter parsed)
- Verify agent has access to phase documentation
- Document symlink resolution behavior in test results

**Must NOT do:**
- Don't spawn real plan generation (use mock/dry-run if possible)
- Don't modify agent files during test

**Complexity**: 3/10
**Location**: Test script (can be temporary)
**Dependencies**: Task 5 (symlink verified)
**Parallelizable**: NO (sequential after Task 5)

**Manual Verification:**
- Step 1: Verify symlink path - `readlink .claude/agents/atlas-prometheus.md`
- Step 2: Test frontmatter parsing - `head -10 .claude/agents/atlas-prometheus.md | grep "name:"`
- Step 3: Spawn test (manual or script) - verify agent loads without path errors
- Expected: Symlink resolves correctly, agent spawns successfully

**Acceptance Criteria:**
- [ ] Symlink resolves to canonical - `readlink .claude/agents/atlas-prometheus.md | grep "skills/atlas/references/agents/atlas-prometheus.md"`
- [ ] Frontmatter accessible via symlink - `head -10 .claude/agents/atlas-prometheus.md | grep "name: atlas-prometheus"`
- [ ] Agent file readable via symlink - `wc -l .claude/agents/atlas-prometheus.md` (expect ~1900 lines)
- [ ] Test results documented - `[ -f .atlas/symlink-test-results.md ]` (or in validation report)

**Commit**: NO (test only, results in validation report)

**Rollback Strategy:**
```bash
# No rollback needed (test only)
```

---

### Task 6: Clean Outdated Guidance from Codex Handoffs

**What to do:**
- Review `.atlas/codex/handoffs/` for files referencing old phase system
- Update or remove outdated planning guidance:
  - `atlas-plan-optimization-handoff.md`
  - `atlas-plan-optimization.md`
  - Any other handoffs mentioning INTERVIEW phase
- Replace old phase references with new names
- Remove any guidance about "keeping INTERVIEW backward compatible"
- Verify handoff templates use new phase names
- **SKIP archived results** (exemption):
  - `.atlas/codex/results/*.md` (read-only archives, don't update)

**Must NOT do:**
- Don't modify active plan files in `.atlas/plans/`
- Don't change handoff format structure
- Don't delete user-created handoffs without verification
- Don't update archived Codex results

**Complexity**: 4/10
**Location**: `.atlas/codex/handoffs/*.md`
**Dependencies**: Task 3 (hooks updated, phase system defined in scripts)
**Parallelizable**: YES (independent from Task 4 after Task 3)

**Manual Verification:**
- Step 1: Search handoffs for old phases - `rg "INTERVIEW|DIRECT_GENERATE|FIX.*phase|CODEX.*phase" .atlas/codex/handoffs/`
- Step 2: Verify handoff templates - `cat .atlas/codex/handoffs/atlas-plan-optimization-handoff.md | grep PHASE`
- Expected: No old phase references in handoff files

**Acceptance Criteria:**
- [ ] No INTERVIEW references - `! rg "PHASE.*INTERVIEW" .atlas/codex/handoffs/`
- [ ] No DIRECT_GENERATE references - `! rg "DIRECT_GENERATE" .atlas/codex/handoffs/`
- [ ] New phase names used - `rg "PHASE: (GENERATE|REVISE|ENHANCE)" .atlas/codex/handoffs/`
- [ ] Handoff templates valid - `cat .atlas/codex/handoffs/*.md | grep "PHASE:" | wc -l` > 0

**Commit**: YES
- Message: `docs(codex): update handoff templates with new phase names`
- Files: `.atlas/codex/handoffs/atlas-plan-optimization-handoff.md`, `.atlas/codex/handoffs/atlas-plan-optimization.md`, (any others)

**Rollback Strategy:**
```bash
git revert <commit-hash>
# Or restore from backup
cp .atlas/backups/phase-redesign-*/codex/handoffs/* .atlas/codex/handoffs/
```

---

### Task 7: Comprehensive Validation and Testing

**What to do:**
- Run full codebase audit for old phase names (excluding CLAUDE.md, backups, and historical docs):
  - `rg "PHASE.*INTERVIEW" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
  - `rg "DIRECT_GENERATE" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
  - `rg "PHASE.*FIX" --type md --type sh --type py -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
  - `rg "PHASE.*CODEX" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
- Verify new phase names present:
  - `rg "PHASE: GENERATE" --type md --type sh -g '!.atlas/backups/*' -g '!.atlas/codex/results/*'`
  - `rg "PHASE: REVISE" --type md --type sh -g '!.atlas/backups/*' -g '!.atlas/codex/results/*'`
  - `rg "PHASE: ENHANCE" --type md --type sh -g '!.atlas/backups/*' -g '!.atlas/codex/results/*'`
- Run test suite:
  - `pytest tests/ -v`
  - `pytest tests/unit/test_state_validate.py -v`
- Verify hook state transitions:
  - Check `.atlas/pipeline-state.json` format (after recreation if needed)
- Generate validation report

**Must NOT do:**
- Don't skip validation steps
- Don't assume tests pass without running
- Don't deploy without comprehensive check
- Don't include backup directories or historical docs in validation

**Complexity**: 5/10
**Location**: Entire codebase validation
**Dependencies**: Tasks 2, 3, 4, 5, 5.5, 6 (all changes complete)
**Parallelizable**: NO (validation after all changes, before Task 7.5)

**Manual Verification:**
- Step 1: Run audit commands - `rg "INTERVIEW|DIRECT_GENERATE" --type md -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*' | wc -l` (expect 0)
- Step 2: Run tests - `pytest tests/ -v`
- Step 3: Check validation report - `cat .atlas/phase-redesign-validation.md`
- Expected: Zero old phase references (except exemptions), all tests pass

**Acceptance Criteria:**
- [ ] No INTERVIEW in agent/hook/doc files - `! rg "PHASE.*INTERVIEW" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
- [ ] No DIRECT_GENERATE in agent/hook/doc files - `! rg "DIRECT_GENERATE" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
- [ ] No old FIX phase references - `! rg "PHASE.*FIX" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
- [ ] No old CODEX phase references - `! rg "PHASE.*CODEX" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'`
- [ ] New phases present in agent - `rg "PHASE: (GENERATE|REVISE|ENHANCE)" skills/atlas/references/agents/atlas-prometheus.md`
- [ ] All tests pass - `pytest tests/ -v --tb=short`
- [ ] State validation tests pass - `pytest tests/unit/test_state_validate.py -v`
- [ ] Validation report generated - `[ -f .atlas/phase-redesign-validation.md ]`

**Commit**: NO (validation only, no file changes)

**Rollback Strategy:**
```bash
# If validation fails, revert all commits
git log --oneline | head -8  # Identify commits (added Task 1 commit)
git revert <commit-6> <commit-5> <commit-4> <commit-3> <commit-2> <commit-1.5> <commit-1>
```

---

### Task 7.5: Runtime End-to-End Smoke Test

**What to do:**
- Manually spawn atlas-prometheus with `PHASE: GENERATE`
- Provide minimal test requirements (e.g., "add hello world function")
- Verify end-to-end pipeline with new phase names:
  1. Prometheus generates plan with GENERATE phase
  2. Plan file created in `.claude/plans/`
  3. Pipeline state uses new phase names if applicable
  4. No errors related to old phase names
- Document smoke test results

**Must NOT do:**
- Don't rely solely on unit tests (need runtime verification)
- Don't skip manual spawn test
- Don't proceed if smoke test fails

**Complexity**: 4/10
**Location**: Manual test execution
**Dependencies**: Task 7 (all validation passes)
**Parallelizable**: NO (final runtime verification)

**Manual Verification:**
- Step 1: Spawn prometheus - manually trigger or use Task tool with PHASE: GENERATE
- Step 2: Verify plan generation - `ls .claude/plans/*.md` (new plan exists)
- Step 3: Check for errors - review output for phase-related errors
- Step 4: Verify pipeline state (if created) - `jq .current_phase .atlas/pipeline-state.json`
- Expected: Plan generated successfully, no phase-related errors, new phase names used

**Acceptance Criteria:**
- [ ] Prometheus spawns successfully with PHASE: GENERATE - manual verification
- [ ] Plan file generated - `[ $(find .claude/plans -name "*.md" -newer .atlas/backups/phase-redesign-* | wc -l) -gt 0 ]`
- [ ] No phase-related errors in output - manual review
- [ ] Pipeline state uses new phase names (if applicable) - `jq .current_phase .atlas/pipeline-state.json | grep -E "GENERATE|PROMETHEUS_REVISE|CODEX_ENHANCE"`
- [ ] Smoke test results documented - in validation report or separate file

**Commit**: NO (test only, results documented)

**Rollback Strategy:**
```bash
# If smoke test fails, revert all commits
git log --oneline | head -8  # Identify commits (added Task 1 commit)
git revert <commit-6> <commit-5> <commit-4> <commit-3> <commit-2> <commit-1.5> <commit-1>
```

---

## Commit Strategy

| After Task | Message | Files | Verification |
|------------|---------|-------|--------------|
| 1 | `chore(atlas): prepare for phase system redesign (backup + gitignore update)` | `.gitignore` | `grep ".atlas/backups" .gitignore` |
| 1.5 | `refactor(schema): update phase enum values (remove INTERVIEW, rename to GENERATE/PROMETHEUS_REVISE/CODEX_ENHANCE)` | `scripts/lib/state_schema.json` | `jq '.properties.current_phase.enum' scripts/lib/state_schema.json` |
| 2 | `refactor(atlas): redesign prometheus phase system (GENERATE, REVISE, ENHANCE)` | `skills/atlas/references/agents/atlas-prometheus.md` | `rg "PHASE: GENERATE" skills/atlas/references/agents/atlas-prometheus.md` |
| 3 | `refactor(hooks): update phase names to GENERATE/REVISE/ENHANCE (includes state machine and ALL tests)` | `scripts/*.sh`, `scripts/lib/pipeline-state-machine.sh`, `tests/unit/test_state_validate.py`, `tests/integration/test_hooks.py`, `tests/unit/test_state_recover.py`, `tests/unit/test_diagnose.py` | `pytest tests/ -v` |
| 4 | `docs(atlas): update phase system documentation (GENERATE/REVISE/ENHANCE) - updated: HOOK_ARCHITECTURE.md, atlas-plan.md, hooks/AGENTS.md, docs/AGENTS.md, skills/atlas/SKILL.md, prometheus.md, .claude/commands/AGENTS.md, tests/AGENTS.md` | `docs/HOOK_ARCHITECTURE.md`, `.claude/commands/atlas-plan.md`, `hooks/AGENTS.md`, `docs/AGENTS.md`, `skills/atlas/SKILL.md`, `skills/atlas/references/workflows/prometheus.md`, `.claude/commands/AGENTS.md`, `tests/AGENTS.md` | `rg "PHASE: REVISE" docs/` |
| 5 | `refactor(atlas): consolidate prometheus agent files (remove duplicates)` | `.claude/agents/prometheus.md` (del), `.claude/skills/atlas/references/agents/atlas-prometheus.md` (del) | `[ ! -f .claude/agents/prometheus.md ]` |
| 6 | `docs(codex): update handoff templates with new phase names` | `.atlas/codex/handoffs/*.md` | `rg "PHASE: GENERATE" .atlas/codex/handoffs/` |

**Note**: Task 5.5 (symlink test), Task 7 (validation), and Task 7.5 (smoke test) do not require commits.

---

## Risks & Mitigation

| Risk | Severity | Probability | Mitigation |
|------|----------|-------------|------------|
| Breaking existing hooks that read phase from state file | HIGH | MEDIUM | Hooks read from pipeline-state.json which we control; update atomically in Task 3; schema migration in Task 1.5 ensures validation; pipeline-state.json backed up in Task 1 before deletion |
| Schema validation breaks with new enum values | HIGH | LOW | Task 1.5 updates schema before agent changes; run pytest immediately after |
| External tools depending on old phase names | MEDIUM | LOW | No known external dependencies; Atlas is self-contained |
| Incomplete search-and-replace missing edge cases | MEDIUM | MEDIUM | Task 7 comprehensive validation with multiple search patterns, excluding backups and historical docs; Codex findings added missing files |
| Symlink resolution breaks on different systems | LOW | LOW | Task 5.5 tests symlink spawn; symlink uses relative path (../../skills/...) which is portable |
| Runtime behavior differs from unit tests | MEDIUM | MEDIUM | Task 7.5 end-to-end smoke test catches runtime issues |
| Rollback complexity if multiple tasks fail | MEDIUM | LOW | Each task has independent rollback strategy; backup in Task 1 includes pipeline-state.json |
| Accidental commit of backup files | LOW | MEDIUM | Task 1 adds `.atlas/backups/` to .gitignore immediately |
| Missing test file updates | MEDIUM | HIGH | Codex identified 3 additional test files; Task 3 now updates ALL tests |

---

## Rollback Plan

### Per-Task Rollback

See individual task rollback strategies above. Each task can be reverted independently.

### Complete Rollback

If multiple tasks fail or system is unstable:

```bash
# 1. Identify commits from this refactor
git log --oneline --since="1 hour ago"

# 2. Revert all phase-redesign commits (in reverse order)
git revert <commit-6> <commit-5> <commit-4> <commit-3> <commit-2> <commit-1.5> <commit-1>

# 3. Or restore entire backup (including pipeline-state.json)
cp -r .atlas/backups/phase-redesign-{timestamp}/* ./

# 4. Verify state
rg "PHASE:" --type md -g '!.atlas/backups/*' | head -20
pytest tests/ -v
```

### Cleanup Commands

```bash
# Remove backup after successful deployment
rm -rf .atlas/backups/phase-redesign-*

# Reset pipeline state if corrupted (restore from backup first)
cp .atlas/backups/phase-redesign-*/pipeline-state.json .atlas/
# Or recover from scratch
rm .atlas/pipeline-state.json
./scripts/state-recover.sh
```

---

## Success Criteria

### Verification Commands

```bash
# No old phase references (except CLAUDE.md, excluding backups and historical docs)
rg "PHASE.*INTERVIEW" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'  # Expected: empty
rg "DIRECT_GENERATE" --type md --type sh -g '!CLAUDE.md' -g '!.atlas/backups/*' -g '!.claude/plans/atlas-plan-optimization.md' -g '!thoughts/*' -g '!.atlas/codex/results/*'   # Expected: empty

# New phase names present
rg "PHASE: GENERATE" skills/atlas/references/agents/atlas-prometheus.md  # Expected: multiple matches
rg "PHASE: REVISE" skills/atlas/references/agents/atlas-prometheus.md    # Expected: multiple matches
rg "PHASE: ENHANCE" skills/atlas/references/agents/atlas-prometheus.md   # Expected: multiple matches

# Schema updated
jq '.properties.current_phase.enum' scripts/lib/state_schema.json  # Expected: contains GENERATE, PROMETHEUS_REVISE, CODEX_ENHANCE

# File consolidation successful
ls -la .claude/agents/ | grep prometheus  # Expected: only symlink atlas-prometheus.md
! ls .claude/agents/prometheus.md         # Expected: file not found

# Tests pass
pytest tests/ -v  # Expected: all green

# .gitignore updated
grep ".atlas/backups" .gitignore  # Expected: match
```

### Final Checklist

- [ ] All "Must Have" present:
  - [ ] INTERVIEW phase completely removed
  - [ ] Schema migrated with new phase enum values
  - [ ] Consistent new phase names (GENERATE, REVISE, ENHANCE)
  - [ ] File duplication resolved (only canonical + symlink)
  - [ ] All hooks updated with new phase names
  - [ ] State machine updated with exact line changes (including line 128)
  - [ ] ALL test files updated with new phase names (unit + integration)
  - [ ] Symlink resolution verified
  - [ ] Runtime smoke test passed
  - [ ] Pipeline-state.json backed up before deletion
  - [ ] `.atlas/backups/` in .gitignore
- [ ] All "Must NOT Have" absent:
  - [ ] CLAUDE.md unchanged
  - [ ] Execution workflow unchanged (atlas-work still works)
  - [ ] Other agents unchanged (metis, momus, leviathan)
  - [ ] Phase behavior unchanged (only renamed)
  - [ ] Backward compatibility maintained for pipeline-state.json
  - [ ] Historical docs unchanged (exemption list)
- [ ] All tests pass
- [ ] Documentation accurate and comprehensive
- [ ] Validation report confirms zero old phase references (excluding exemptions)
- [ ] End-to-end smoke test successful
