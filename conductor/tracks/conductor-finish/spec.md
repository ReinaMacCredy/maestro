# Spec: /conductor-finish Integration

## Overview

Integrate doc-sync functionality into conductor as `/conductor-finish` command, completing the track lifecycle with automated knowledge extraction, beads compaction, and archival.

## Requirements

### Functional Requirements

#### FR1: /conductor-finish Command
- Add `/conductor-finish [track_id]` to conductor skill
- Accept optional `--with-pr` flag to chain with finish-branch skill
- Support both manual invocation and auto-trigger

#### FR2: Auto-Trigger Mechanism
- Detect track completion via `metadata.json` status = "ready_to_finish"
- Set status automatically when last epic completes in `/conductor-implement`
- Prompt user: "Track ready. Run `/conductor-finish`?"

#### FR3: Validation & Warnings
- Check for open beads before proceeding
- Check for incomplete epics in plan.md
- Warn user and ask to continue (y/n) if issues found
- Never block, only warn

#### FR4: Phase 1 - Thread Compaction
- Extract thread URLs using fallback chain:
  1. Beads comments (THREAD: urls)
  2. metadata.json threadIds
  3. find_thread with changed files
  4. Skip phase if none found
- Read threads using read_thread tool
- Extract: commands, gotchas, patterns
- Write to `tracks/<id>/LEARNINGS.md` using template
- Show progress: "Phase 1/4: Extracting from N threads..."

#### FR5: Phase 2 - Beads Compaction
- Find closed beads without AI summary
- Generate summaries using issue content
- Apply via `bd compact --apply --id <id> --summary "<text>"`
- Skip if no closed beads without summary
- Show progress: "Phase 2/4: Compacting N beads..."

#### FR6: Phase 3 - Knowledge Merge
- Parse LEARNINGS.md sections
- Check conductor/AGENTS.md exists, create with template if not
- Deduplicate against existing content
- Selective sync: only Commands, Gotchas, Patterns
- Show git diff for user review
- Show progress: "Phase 3/4: Merging to conductor/AGENTS.md..."

#### FR7: Phase 4 - Archive
- Present S/H/K choice:
  - **S** (Soft): Set metadata.json status = "archived", keep in tracks/
  - **H** (Hard): Move to conductor/archive/
  - **K** (Keep): No archival, stay active
- Cleanup beads exceeding threshold (150 closed)
- Single commit: "complete(track_id): N learnings extracted"
- Show progress: "Phase 4/4: Preparing archive..."

#### FR8: Resume Capability
- Create `finish-state.json` at start with: phase, startedAt, completed[]
- Update after each phase completes
- On re-run, detect finish-state.json and prompt to resume
- Delete finish-state.json on successful completion

#### FR9: Progress Feedback
- Show phase progress: "Phase N/4: description..."
- Show line counts: "→ LEARNINGS.md: +12 lines"
- Show summary counts: "→ 5 summaries applied"
- Show merge stats: "→ +5 lines (2 commands, 1 gotcha)"

#### FR10: Optional PR Integration
- If `--with-pr` flag provided, invoke finish-branch skill after Phase 4
- Pass track context to finish-branch

### Non-Functional Requirements

#### NFR1: Idempotency
- All phases must be safe to re-run
- Phase 1: Overwrites LEARNINGS.md
- Phase 2: bd compact --apply is idempotent
- Phase 3: Dedup prevents duplicate entries
- Phase 4: Archive prompt re-asked

#### NFR2: Error Handling
- Phase 1-2: Best effort, log warnings, continue
- Phase 3: Required, stop on failure
- Phase 4: Only runs if Phase 3 succeeds

#### NFR3: Performance
- No timeout on thread reading (may take time)
- Show progress to indicate activity

## Files to Create/Modify

### New Files

| File | Purpose |
|------|---------|
| `skills/conductor/references/finish-workflow.md` | Detailed 4-phase workflow instructions |
| `skills/conductor/references/validation/README.md` | Explain reserved quality rubrics |
| `conductor/AGENTS.md` | Template for learnings hub |
| `tracks/<id>/LEARNINGS.md` | Per-track extracted knowledge |
| `tracks/<id>/finish-state.json` | Resume state |

### Modified Files

| File | Changes |
|------|---------|
| `skills/conductor/SKILL.md` | Add /conductor-finish command, intent mapping |
| `skills/design/SKILL.md` | Update pipeline diagram |
| `AGENTS.md` (root) | Replace doc-sync mentions with /conductor-finish |
| `tracks/<id>/metadata.json` | Add docSync field, status updates |

### Moved Files

| From | To |
|------|-----|
| `commands/compact/judge-prompt.md` | `skills/conductor/references/validation/judge-prompt.md` |
| `commands/compact/rubrics.md` | `skills/conductor/references/validation/rubrics.md` |

### Deleted Files

| File | Reason |
|------|--------|
| `skills/doc-sync/SKILL.md` | Merged into conductor |
| `commands/compact/` | Moved to validation/ |

## Templates

### LEARNINGS.md Template

```markdown
# Learnings: {{track_id}}

<!-- Auto-generated by /conductor-finish -->

## Commands
<!-- CLI commands discovered -->

## Gotchas
<!-- Pitfalls, edge cases, warnings -->

## Patterns
<!-- Reusable patterns (optional) -->

---
**Source threads:**
- {{thread_id}}: {{description}}
```

### conductor/AGENTS.md Template

```markdown
<!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->

# Conductor Learnings

Knowledge extracted from completed tracks.

## About This File

This file is auto-updated by `/conductor-finish`.
Contains reusable learnings from completed tracks.

**Do not edit manually** - changes may be overwritten.

---

## Commands

## Gotchas

## Patterns
```

### finish-state.json Schema

```json
{
  "phase": 1,
  "startedAt": "ISO-8601 timestamp",
  "completed": ["thread-compaction", "beads-compaction"]
}
```

### metadata.json docSync Addition

```json
{
  "docSync": {
    "at": "ISO-8601 timestamp",
    "threads": ["T-xxx"],
    "itemsAdded": 3,
    "archiveChoice": "soft|hard|keep"
  }
}
```

## Acceptance Criteria

### AC1: Command Available
- [ ] `/conductor-finish` appears in conductor SKILL.md slash commands table
- [ ] Intent mapping includes "finish track", "doc-sync" triggers

### AC2: Auto-Trigger Works
- [ ] Last epic completion sets metadata.json status = "ready_to_finish"
- [ ] Agent prompts user to run /conductor-finish

### AC3: Validation Works
- [ ] Open beads trigger warning with continue prompt
- [ ] Incomplete epics trigger warning with continue prompt

### AC4: Phase 1 Works
- [ ] Fallback chain attempts all sources
- [ ] LEARNINGS.md created with template structure
- [ ] Smart skip when no threads found

### AC5: Phase 2 Works
- [ ] Closed beads get AI summaries
- [ ] bd compact --apply called correctly
- [ ] Smart skip when no beads need summary

### AC6: Phase 3 Works
- [ ] conductor/AGENTS.md created if missing
- [ ] Deduplication prevents duplicates
- [ ] Git diff shown for review

### AC7: Phase 4 Works
- [ ] S/H/K prompt displayed
- [ ] Soft archive updates metadata only
- [ ] Hard archive moves to archive/
- [ ] Keep does nothing
- [ ] Beads cleanup respects threshold 150

### AC8: Resume Works
- [ ] finish-state.json created at start
- [ ] Resume prompt on re-run
- [ ] Correct phase resumed

### AC9: Files Cleaned Up
- [ ] skills/doc-sync/ deleted
- [ ] commands/compact/ deleted
- [ ] validation/ files in correct location

### AC10: Documentation Updated
- [ ] design/SKILL.md pipeline diagram updated
- [ ] Root AGENTS.md updated

## Out of Scope

- Multi-repo track support
- Quality scoring of extractions
- --skip-compaction flag
- Release notes generation
- CHANGELOG.md updates
- CI/CD triggers
- Skill-specific AGENTS.md routing
