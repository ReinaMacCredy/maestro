# Learnings: pre-orchestration-optimization

<!-- Auto-generated by /conductor-finish -->

## Commands

- `bd list --parent <epic-id> --json | jq '[.[] | select(.status == "open")]'` - Filter beads by status
- `bd dep tree <epic-id>` - View dependency tree for epic
- `bd list --json | jq '[.[] | select(.dependency_count <= 1)]'` - Find low-dependency beads for parallel execution
- `macro_start_session()` - Single MCP call for orchestrator/worker initialization (replaces ensure_project + register_agent)

## Gotchas

- Orchestrator pre-registration is wasteful: Workers should self-register via `macro_start_session` in Step 1
- EPIC START message must go to orchestrator itself (`to=[ORCHESTRATOR_NAME]`) not workers who don't exist yet
- `preflight-beads.md` triage runs even when beads are already filed - check `metadata.beads.status == "complete"` first
- Handoff load runs for fresh sessions - skip when `conductor/handoffs/<track>/` is empty
- Track Assignments parsing is redundant when already present - use `parse_track_assignments_table()` directly
- Confirmation prompt re-analyzes file scopes - should use pre-parsed track data

## Patterns

**Worker 4-Step Protocol:**
```
STEP 1: REGISTER (macro_start_session - FIRST)
STEP 2: EXECUTE  (claim beads, do work, close beads)
STEP 3: REPORT   (send_message to orchestrator)
STEP 4: CLEANUP  (release_file_reservations)
```

**Lazy References (Trigger-Based Loading):**
```markdown
| Phase | Reference |
|-------|-----------|
| Always | SKILL.md only |
| Phase 3 (Initialize) | agent-mail.md |
| Phase 4 (Spawn) | worker-prompt.md |
| Phase 6 (Handle Issues) | agent-coordination.md |
```

**Triage Cache Structure:**
```json
{
  "beads": {
    "triageCache": {
      "cachedAt": "2026-01-02T12:00:00Z",
      "ttlSeconds": 3600,
      "results": [...],
      "counts": { "ready": 3, "in_progress": 1, "blocked": 0, "closed": 2 }
    }
  }
}
```

---

**Source threads:**
- T-019b7e8d-e489-72b2-a697-4a2e5c1657a4: Parallel orchestration implementation (4 waves, 21 beads)
