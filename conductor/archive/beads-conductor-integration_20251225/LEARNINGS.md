# Learnings: beads-conductor-integration_20251225

<!-- Auto-generated by /conductor-finish -->

## Commands

- `bd update <id> --status in_progress` - Claim task in SA mode
- `bd close <id> --reason completed|skipped|blocked` - Close with reason
- `bd compact --analyze --json` - Find beads needing AI summaries
- `bd compact --apply --id <id> --summary "<text>"` - Apply AI summary
- `bd count --status closed --json` - Count closed for cleanup threshold
- `bd cleanup --older-than 0 --limit <n> --force` - Remove oldest closed beads
- `bv --robot-status` - Check Village MCP status (use --robot-* flags to avoid TUI)
- `/conductor-implement --tdd` - Enable TDD checkpoint tracking (opt-in)

## Gotchas

- **HALT vs Degrade**: `bd` unavailable = HALT; Village unavailable in MA mode = degrade to SA with warning
- **Session lock staleness**: Use heartbeat protocol (5 min updates); stale = >10 min without heartbeat
- **Subagent bd access**: Read-only (`show`, `ready`, `list`); writes return to main agent
- **Idempotency**: `bd update` and `bd close` are idempotent; `bd create` is NOT (HALT on failure)
- **Compaction conflict**: If bead was cleaned up but needs reopening, create NEW bead with lineage reference
- **Atomic writes**: Use `$$` (PID) suffix for temp files to prevent collisions
- **planTasks mapping**: Bidirectional - keep `planTasks` and `beadToTask` in sync

## Patterns

- **Facade Pattern**: Single integration layer (`beads-facade.md`) abstracts SA/MA mode differences
- **State Files First**: Create all 3 state files (metadata.json, .track-progress.json, .fb-progress.json) at track init BEFORE spec/plan generation
- **Retry with Persistence**: 3 retries with backoff; on failure, persist to `.conductor/pending_*.jsonl` for replay
- **Preflight at Session Start**: Mode detection, bd availability check, session state creation, pending op recovery
- **Close with Reason**: Always specify `completed`, `skipped`, or `blocked` to enable proper status sync

---

**Source threads:**

- T-019b5567-ee85-737c-85f0-b30b80e6cac1: Beads-Conductor Integration Design Session
