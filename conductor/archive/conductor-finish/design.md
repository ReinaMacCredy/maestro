# Design: /conductor-finish Integration

## Problem Statement

> **doc-sync is an orphan skill** not integrated with the conductor workflow, causing knowledge loss because users forget to run it, timing is unclear, and the workflow is fragmented across multiple commands.

## Solution

Merge doc-sync into conductor as `/conductor-finish` - the final phase of the track lifecycle.

```
/conductor-design → /conductor-newtrack → /conductor-implement → /conductor-finish
```

## Success Criteria

| Metric              | Target                               |
| ------------------- | ------------------------------------ |
| Single command      | 1 command completes track entirely   |
| Auto-trigger        | Track complete → finish runs         |
| Knowledge preserved | 100% learnings → conductor/AGENTS.md |
| Resume capability   | Crash → resume from failed phase     |
| Zero orphan skills  | doc-sync deprecated                  |

## Architecture

### `/conductor-finish` Workflow

```
┌─────────────────────────────────────────────────────────────┐
│                     /conductor-finish                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [Validation] → Check open beads/epics, warn if incomplete  │
│       ↓                                                     │
│  [Phase 1: Thread Compaction]                               │
│       → Fallback chain: beads comments → metadata → find    │
│       → Extract learnings → LEARNINGS.md                    │
│       → Smart skip if no threads                            │
│       ↓                                                     │
│  [Phase 2: Beads Compaction]                                │
│       → AI summaries for closed issues                      │
│       → bd compact --apply                                  │
│       → Smart skip if no closed beads                       │
│       ↓                                                     │
│  [Phase 3: Knowledge Merge]                                 │
│       → Parse LEARNINGS.md                                  │
│       → Dedup + selective sync                              │
│       → Merge to conductor/AGENTS.md                        │
│       → User review via git diff                            │
│       ↓                                                     │
│  [Phase 4: Archive]                                         │
│       → S/H/K prompt (Soft/Hard/Keep)                       │
│       → Single commit: "complete(track_id)"                 │
│       → Cleanup beads (threshold 150)                       │
│       ↓                                                     │
│  [Optional: --with-pr]                                      │
│       → Chain to finish-branch skill                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### File Structure

```
skills/conductor/                       ← SKILL (rules, instructions)
├── SKILL.md                           ← Updated with /conductor-finish
├── references/
│   ├── structure.md
│   ├── workflows.md
│   ├── finish-workflow.md             ← NEW: 4-phase detail
│   └── validation/                    ← NEW: moved from commands/compact/
│       ├── README.md
│       ├── judge-prompt.md
│       └── rubrics.md

conductor/                              ← PROJECT DATA (per-project)
├── AGENTS.md                          ← NEW: learnings hub
├── product.md
├── tech-stack.md
├── tracks/<id>/
│   ├── LEARNINGS.md                   ← NEW: created by finish
│   ├── finish-state.json              ← NEW: resume state (if interrupted)
│   └── metadata.json                  ← Updated with docSync log
└── archive/

skills/doc-sync/                        ← DELETED
commands/compact/                       ← DELETED (moved)
```

## Key Decisions

### 1. Trigger Mechanism

- **Auto-trigger:** metadata.json status = "ready_to_finish" (set when last epic completes)
- **Manual:** User runs `/conductor-finish <track_id>`
- **Validation:** Warns if open beads or incomplete epics, asks to continue

### 2. Thread Fallback Chain

```
1. Check beads comments for THREAD: urls
   ↓ not found
2. Check metadata.json threadIds
   ↓ not found
3. find_thread file:<changed-files-from-git>
   ↓ not found
4. Skip Phase 1, log warning, proceed to Phase 2
```

### 3. Archive Options (S/H/K)

| Choice       | Action                                          |
| ------------ | ----------------------------------------------- |
| **S** (Soft) | Mark archived in metadata.json, keep in tracks/ |
| **H** (Hard) | Move to archive/ immediately                    |
| **K** (Keep) | Don't archive, stay active                      |

### 4. LEARNINGS.md Template

```markdown
# Learnings: {{track_id}}

<!-- Auto-generated by /conductor-finish -->

## Commands

<!-- CLI commands discovered -->

## Gotchas

<!-- Pitfalls, edge cases, warnings -->

## Patterns

<!-- Reusable patterns (optional) -->

---

**Source threads:**

- T-xxx: description
```

### 5. conductor/AGENTS.md Template

```markdown
<!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->

# Conductor Learnings

Knowledge extracted from completed tracks.

## About This File

This file is auto-updated by `/conductor-finish`.
Contains reusable learnings from completed tracks.

**Do not edit manually** - changes may be overwritten.

---

## Commands

## Gotchas

## Patterns
```

### 6. finish-state.json (Minimal)

```json
{
  "phase": 2,
  "startedAt": "2025-12-23T10:30:00Z",
  "completed": ["thread-compaction"]
}
```

### 7. metadata.json docSync Addition

```json
{
  "id": "track-id",
  "status": "archived",
  "docSync": {
    "at": "2025-12-23T10:30:00Z",
    "threads": ["T-abc123"],
    "itemsAdded": 3,
    "archiveChoice": "soft"
  }
}
```

## Scope

### In Scope

- `/conductor-finish` command
- Auto-trigger on track complete
- 4-phase workflow (thread, beads, merge, archive)
- finish-state.json for resume
- LEARNINGS.md per track
- conductor/AGENTS.md as hub
- Dedup + selective sync
- S/H/K archive choice
- `--with-pr` flag to chain finish-branch
- doc-sync deletion
- commands/compact → validation/ move

### Out of Scope

- Multi-repo tracks (single-repo only)
- Quality scoring (use template instead)
- `--skip-compaction` flag (smart auto-skip instead)
- Release notes generation
- CHANGELOG.md updates
- CI/CD triggers
- Skill-specific AGENTS.md routing (use conductor/AGENTS.md only)

## Implementation Checklist

| #   | Task                                | Files                                                           |
| --- | ----------------------------------- | --------------------------------------------------------------- |
| 1   | Create finish-workflow.md           | `skills/conductor/references/finish-workflow.md`                |
| 2   | Update conductor/SKILL.md           | Add /conductor-finish section                                   |
| 3   | Create conductor/AGENTS.md template | `conductor/AGENTS.md`                                           |
| 4   | Move validation files               | `commands/compact/` → `skills/conductor/references/validation/` |
| 5   | Delete doc-sync skill               | Remove `skills/doc-sync/`                                       |
| 6   | Delete commands/compact             | Remove after move                                               |
| 7   | Update design/SKILL.md              | Pipeline diagram                                                |
| 8   | Update root AGENTS.md               | Replace doc-sync mentions                                       |

## Error Handling

| Phase             | On Failure                    |
| ----------------- | ----------------------------- |
| Phase 1 (Thread)  | Log warning, skip, continue   |
| Phase 2 (Beads)   | Log warning, skip, continue   |
| Phase 3 (Merge)   | **Required** - stop if fails  |
| Phase 4 (Archive) | Only runs if Phase 3 succeeds |

Resume: If interrupted, finish-state.json allows resuming from last completed phase.

## Edge Cases

| Case                                | Handling                      |
| ----------------------------------- | ----------------------------- |
| Track has no beads                  | Skip Phase 2, log warning     |
| Track has no threads                | Fallback chain → skip Phase 1 |
| Fresh repo (no conductor/AGENTS.md) | Create with template          |
| finish-state.json corrupted         | Delete and restart            |
| User runs finish twice              | Idempotent - safe to re-run   |
| Open beads/epics                    | Warn, ask to continue         |

## Progress Feedback

```
/conductor-finish changelog-cicd

Validating track... ✓
  ⚠ 2 beads still open. Continue? (y/n) y

Phase 1/4: Extracting from 3 threads...
  → LEARNINGS.md: +12 lines
Phase 2/4: Compacting 5 beads...
  → 5 summaries applied
Phase 3/4: Merging to conductor/AGENTS.md...
  → +5 lines (2 commands, 1 gotcha)
Phase 4/4: Preparing archive...

Review changes? [Y/n] y
  [shows git diff]

Archive choice:
[S] Soft - keep in tracks/, cleanup later
[H] Hard - move to archive/ now
[K] Keep - don't archive yet
> S

✓ Track completed. Commit: abc123
```

## Design Session Metadata

- **Date:** 2025-12-23
- **Phases:** DISCOVER → DEFINE → DEVELOP → DELIVER
- **Party Mode Rounds:** 6
- **Advanced Mode:** 2
- **Key Contributors:** Winston (Architect), Amelia (Developer), Paige (Docs), Mary (Analyst), Murat (QA), Victor (Strategist), Sally (UX), Maya (Design Thinking), Carson (Brainstorm), Dr. Quinn (Solver), John (PM), Sophia (Storyteller)
