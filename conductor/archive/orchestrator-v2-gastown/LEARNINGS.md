# Learnings: orchestrator-v2-gastown

<!-- Auto-generated by /conductor-finish -->

## Commands

- `bd update <bead_id> --status in_progress` - Claim task
- `bd close <bead_id> --reason completed|skipped|blocked` - Close with explicit reason
- `bd close id1 id2 id3 --reason completed` - Close multiple beads at once
- `/conductor-implement` - Execute with TDD checkpoints by default (use `--no-tdd` to disable)
- `/conductor-handoff` - Unified handoff command with auto-detect
- `bd update <bead_id> --assignee <agent>` - Assign task to worker
- `bd list --stale=30m --status in_progress` - Find stuck tasks
- `bd create --wisp` - Create ephemeral bead for patrol
- `bd burn <wisp-id>` - Delete ephemeral bead
- `bd squash <wisp-id> --title "..."` - Convert wisp to permanent bead
- `bd heartbeat <bead-id>` - Send worker heartbeat

## Gotchas

- **Parallel worker spawn exhausts file descriptors**: When 6+ workers call `macro_start_session()` simultaneously, Agent Mail archive lock contention causes `OSError: Too many open files`. Fix: stagger spawns in batches of 3.
- Lean orchestrator pattern: keep SKILL.md ≤100 lines, move detailed logic to references/.
- Session lock staleness: heartbeat protocol (5 min updates); stale = >10 min without heartbeat.
- Subagent bd access: read-only (show, ready, list); writes return to main agent.
- Worker Protocol v2 requires `macro_start_session()` as FIRST action before any other work.
- PING/PONG requires inline inbox checks during work loop (every 2-3 minutes).

## Patterns

- **Hybrid Hook Pattern**: Agent Mail for signals (WAKE, ASSIGN), Beads for state ownership (--assignee field).
- **Self-Propulsion**: Workers check inbox on start, query assigned beads, execute immediately without waiting for commands.
- **Typed Message Protocol**: 11 message types with YAML frontmatter (ASSIGN, WAKE, PING, PONG, PROGRESS, BLOCKED, COMPLETED, FAILED, STEAL, RELEASE, ESCALATE).
- **Wisps (Ephemeral Beads)**: For patrol/monitoring without polluting git history. Created with `--wisp`, deleted with `bd burn`.
- **Witness Patrol**: Integrated monitoring loop with 4 checks - stale tasks, unblocked deps, load balance, orphaned tasks.
- **Staggered Spawning**: Spawn workers in batches of 3 to prevent file descriptor exhaustion.
- **7-Step Worker Startup**: INITIALIZE → INBOX CHECK → THREAD LOCATE → BEADS QUERY → CLAIM → RESERVE → EXECUTE.
- **Atomic Claiming**: `--expect-status=open` flag for race-free bead claiming in parallel environments.

---

**Source threads:**
- T-019b801b-b8e4-7109-8cdd-d05627e8c7f7: Orchestrator v2 Gas Town implementation
