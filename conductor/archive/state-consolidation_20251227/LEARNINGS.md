# Learnings: state-consolidation_20251227

<!-- Auto-generated by /conductor-finish -->

## Commands

- `update_ledger_field "field" "value"` - Helper function for updating LEDGER.md frontmatter fields atomically
- `sed -n '/^---$/,/^---$/p' "$LEDGER_FILE" | grep '^field:' | cut -d' ' -f2` - Extract frontmatter field from LEDGER.md
- `bd close id1 id2 id3 --reason completed` - Close multiple beads at once

## Gotchas

- session-state_*.json files are replaced by LEDGER.md frontmatter - update all references
- session-lock_*.json files are still used for concurrent session prevention (separate from session state)
- LEDGER.md frontmatter must be reconstructed atomically using temp file + mv pattern
- Mode detection now checks LEDGER.md frontmatter instead of session-state JSON
- Heartbeat updates in background loop now target LEDGER.md updated + heartbeat fields
- Stale agent detection (MA mode) checks session-lock files, not LEDGER (LEDGER is per-agent)
- metadata.json.beads replaces .fb-progress.json for planTasks mapping
- metadata.json.generation replaces .track-progress.json for spec/plan state

## Patterns

- **State File Consolidation:** Replace N separate state files with sections in a single consolidated file
- **Update Schema First:** When consolidating, update schema definitions before updating code/docs that reference them
- **Atomic YAML Frontmatter Updates:** Extract body, rebuild frontmatter, write to temp file, mv to target
- **Track Binding Flow:** null → bound_track → bound_bead → null (lifecycle matches Conductor workflow)
- **Non-blocking Continuity:** All continuity operations in Conductor phases log warnings but never halt commands

---

**Source threads:**
- T-019b5f4b-2ed8-70f9-8a40-7def13fc5516: Epic 2 implementation (session state consolidation)
- T-019b5f58-91c3-73e9-b78a-aebde58fc036: Epic 3 implementation (continuity ↔ conductor integration)
