<!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->

# Conductor Learnings

Knowledge extracted from completed tracks.

## About This File

This file is auto-updated by `/conductor-finish`.
Contains reusable learnings from completed tracks.

**Do not edit manually** - changes may be overwritten.

---

## Commands

- `bd dep add <child> <parent>` - Wire dependencies after bead creation (not auto-mapped from plan)
- `./scripts/validate-links.sh .` - Validate markdown links in codebase
- `./scripts/validate-anchors.sh .` - Validate anchor references
- `sed -i '' 's|old|new|g' file` - macOS in-place sed replacement
- `rg "pattern" --type md -l` - Find files containing pattern
- `tail -n +N file` - Strip first N-1 lines (useful for removing YAML frontmatter)
- `rm -rf skills/X .claude/skills/X` - Delete both hard-linked paths when removing skills
- `bd compact --analyze --json` - Find beads needing summaries
- `bd compact --apply --id <id> --summary "<text>"` - Apply AI summary to bead
- `bd count --status closed --json` - Count closed beads for cleanup threshold
- `bd cleanup --older-than 0 --limit <n> --force` - Remove oldest closed beads
- `bd update <id> --status in_progress` - Claim task in SA mode
- `bd close <id> --reason completed|skipped|blocked` - Close with explicit reason
- `bv --robot-status` - Check Village MCP status (use --robot-* flags to avoid TUI hang)
- `/conductor-implement` - Execute with TDD checkpoints by default (use `--no-tdd` to disable)
- `wc -l <file>.csv` - Verify CSV row counts match upstream when syncing data files
- `curl -s https://raw.githubusercontent.com/.../file.csv` - Sync CSV data directly from upstream repo
- `uv run scripts/artifact-index.py` - Build/rebuild SQLite FTS5 index of handoffs
- `uv run scripts/artifact-index.py --verify` - Check index integrity
- `uv run scripts/artifact-query.py <query>` - Search archived handoffs with FTS5
- `uv run scripts/artifact-cleanup.py --dry-run` - Preview handoffs to delete
- `./scripts/install-global-hooks.sh` - Install Claude Code hooks to ~/.claude/hooks/
- `git branch --show-current` - Get current branch for preflight checks
- `git status --porcelain` - Check for dirty state (empty = clean)
- `git show-ref --verify --quiet "refs/heads/$BRANCH"` - Check if branch exists
- `jq '.workflow.state = "ARCHIVED"' metadata.json > "metadata.json.tmp.$$" && mv "metadata.json.tmp.$$" metadata.json` - Update workflow state atomically
- `/doc-sync` - Sync documentation with code changes
- `/doc-sync --dry-run` - Preview doc changes without applying
- `/doc-sync --force` - Apply all doc changes without prompts
- `sed -n '/^---$/,/^---$/p' "$FILE" | grep '^field:' | cut -d' ' -f2` - Extract YAML frontmatter field value
- `bd close id1 id2 id3 --reason completed` - Close multiple beads at once
- `/create_handoff` - Create handoff file manually
- `/resume_handoff` - Load most recent handoff for track
- `ls skills/conductor/references/` - Verify reference structure after migration
- `/conductor-orchestrate` - Spawn parallel workers for track execution (Mode B workers)
- `bv --robot-triage --graph-root <epic-id>` - Prepare beads for orchestration ("dọn cỗ")
- `bv --robot-triage --graph-root <epic-id> --json` - Get JSON output for auto-orchestration graph analysis
- `bd list --json | jq '. | length'` - Count beads reliably (returns array, not object)
- `grep -l "send_message" skills/orchestrator/agents/**/*.md | wc -l` - Verify all agents have mandatory Agent Mail save
- `mcp__mcp_agent_mail__register_agent` - Register orchestrator identity before spawning workers

## Gotchas

- Skill prerequisite pattern uses markdown `**REQUIRED SUB-SKILL:**` not frontmatter `requires:`
- Design skill's HALT on missing conductor/ was adoption blocker - changed to DEGRADE (standalone mode)
- Lean orchestrator pattern: keep SKILL.md ≤100 lines, move detailed logic to references/
- Hard-linked directories (skills/ ↔ .claude/skills/) - updating one updates both, but explicitly delete both
- Thin skill stubs must include keyword-rich descriptions for AI trigger matching
- Delete operations must wait for reference replacements - deleting too early causes broken references
- Relative paths change when files move - `references/X.md` becomes `./X.md` when you're already in references/
- Archive files contain historical references - don't fix them (they're snapshots)
- Party-mode agent paths need updating when workflow moves
- Phase 3 (Knowledge Merge) is required - if it fails, stop workflow
- Phases 1 & 2 are best-effort - failures should log warnings but continue
- Context Refresh (Phase 4) can be skipped with --skip-refresh flag
- User input A/K must be mapped to JSON values "archive"/"keep"
- Atomic writes use $$ (PID) suffix for temp files to prevent collisions
- CODEMAPS loaded at design session start for codebase context
- docs: and chore: commits don't bump version (changelog only)
- Skill versions in SKILL.md frontmatter are manually updated (not automated)
- HALT vs Degrade: `bd` unavailable = HALT; Village unavailable in MA = degrade to SA
- Session lock staleness: heartbeat protocol (5 min updates); stale = >10 min without heartbeat
- Subagent bd access: read-only (show, ready, list); writes return to main agent
- Idempotency: `bd update` and `bd close` are idempotent; `bd create` is NOT
- planTasks mapping: bidirectional - keep planTasks and beadToTask in sync
- Claude Code hooks must exit 0 even on error (try/catch + graceful exit) to avoid crashing Claude
- Handoffs in conductor/handoffs/<track>/ are git-committed (shareable), archived on /conductor-finish
- Stale handoffs (>7 days) trigger warning on /resume_handoff
- FTS5 snippet function: `snippet(handoffs_fts, 2, '>>>', '<<<', '...', 50)` for match highlighting
- artifact-cleanup.py parses dates from filenames (YYYY-MM-DD-HH-MM-trigger.md), not frontmatter
- Concurrent sessions on same codebase may conflict - documented limitation (last writer wins)
- Session continuity is automatic via workflow entry points (ds, /conductor-implement, /conductor-finish)
- Validation state tracked in metadata.json.validation, not LEDGER.md
- State machine uses STRICT vs SOFT enforcement - STRICT transitions HALT, SOFT only WARN
- Default branch names differ by repo: check for BOTH `main` AND `master`
- Auto-archive removes A/K prompt entirely - use `--keep` flag to prevent archiving
- Open beads cause HALT at finish unless `--force` is used
- Branch suffix auto-increments (-v2, -v3) if branch already exists
- `workflow.state` for machine logic, `status` field for human readability
- Doc-sync runs as Phase 7 in `/conductor-finish` (after CODEMAPS)
- Doc-sync errors are non-blocking - workflow continues even if doc-sync fails
- Minor doc changes (path renames, function renames) are auto-applied
- Major doc changes (new features, removed features) prompt user
- Track-switch auto-archives handoffs - switching tracks preserves previous session context
- Handoff operations in Conductor are non-blocking - failures log warnings but never halt commands
- Research: All agents fail → block with `MANUAL_VERIFY`, not silent proceed
- Research: Timeout → return partial results + warning (soft limits), not hard failure
- Research: Network failure → graceful fallback to repo-only mode
- Research: Conflict resolution → auto-prefer highest confidence BUT show conflict summary
- Research: ALWAYS runs - no skip conditions (parallel agents are fast)
- Extraction fidelity: Initial skill extraction may lose philosophical content (e.g., "Why Order Matters"). Fix: copy full SKILL.md first, then split.
- Continuity skill is in marketplace plugin, not local skills/ - can't add direct local dependency checks
- Session start detection without hooks requires implicit trigger (maestro-core loading on first message)
- Ad-hoc queries (not triggering `ds`, `/conductor-implement`, etc.) do NOT load handoff history - intentional low-overhead behavior for casual chats
- Agent Mail MCP Failure: If Agent Mail unavailable, graceful fallback to sequential `/conductor-implement`
- Runtime Testing: Integration tests (Agent Mail, worker spawn) require live MCP - skip with `--reason skipped`
- Worker Autonomy: Orchestrator workers CAN self claim/close beads (differs from standard subagent rules)
- Auto-orchestration: fb Phase 6 triggers orchestration automatically after beads are filed
- `metadata.json.beads.orchestrated` flag ensures idempotency - re-running fb skips if already orchestrated
- Duplicate beads during parallel filing: Issues created multiple times require manual closure with reason "Duplicate of X"
- Epic status not auto-updating: Epics remain `open` after all child tasks closed; manually close with `bd close <epic-id> --reason completed`
- jq array parsing: `bd list --json` returns array, not object; use `jq '. | length'` not `jq '.issues | length'`
- Metadata state sync: After `fb` filing, must run `bd sync` before implementation to ensure database state is current
- Agent Mail primary, markdown secondary: Send handoffs to Agent Mail first for FTS5 search, write markdown for git history

## Patterns

- **6-Level Skill Hierarchy:** maestro-core > conductor > orchestrator > design > beads > specialized (higher level wins on conflicts)
- **Context-Aware Routing:** Check explicit commands first, then context (conductor/ exists?) for routing
- **6-Phase Finish Workflow:** Pre-flight → Thread Compaction → Beads Compaction → Knowledge Merge → Context Refresh → Archive → CODEMAPS
- **Smart Skip:** Each phase checks if work exists before running
- **Resume Capability:** State files track progress for interrupted workflows
- **A/K Archive Choice:** Archive (move to archive/) / Keep (stay active)
- **State Files First:** Create metadata.json with generation and beads sections in Phase 1.3 BEFORE spec/plan generation
- **Collective State Validation:** Treat 3 state files as atomic unit - HAS_STATE = 0 (none), 1 (partial), 2 (all)
- **Double Diamond Phases:** DISCOVER (diverge) → DEFINE (converge) → DEVELOP (diverge) → DELIVER (converge)
- **A/P/C Checkpoints:** At each phase end: [A] Advanced, [P] Party (multi-agent), [C] Continue
- **Unified Track Creation:** /conductor-newtrack includes spec, plan, beads filing, AND review in one flow
- **Conventional Commits Versioning:** feat: → minor, fix: → patch, feat!: → major
- **COMPLEXITY_EXPLAINER:** Score-based design routing (SPEED <4, ASK 4-6, FULL >6)
- **Execution Routing:** TIER 1 (weighted score) + TIER 2 (compound conditions) → SINGLE_AGENT or PARALLEL_DISPATCH
- **RECALL/REMEMBER:** Session lifecycle with anchored format for cross-session context
- **Degradation Signals:** tool_repeat, backtrack, quality_drop, contradiction → 2+ signals triggers compression
- **Anchored Format:** [PRESERVE] markers for Intent and Constraints sections that survive compression
- **Continuity Chain:** `/conductor-implement` (Phase 0.5: load) → work → `/conductor-finish` (Phase 6.5: handoff)
- **State File Consolidation:** Replace N separate state files with sections in a single consolidated file (e.g., metadata.json.beads replaces .fb-progress.json)
- **Track Binding Flow:** null → bound_track → bound_bead → null (lifecycle matches Conductor workflow)
- **Research Protocol:** Parallel agents (Locator + Analyzer + Pattern + Web + Impact) replace sequential grounding
- **Always-On Research:** No skip conditions - research runs at ds, DEVELOP→DELIVER, and newtrack
- **Enforcement Levels:** Advisory (log) → Gatekeeper (block if missing) → Mandatory (block if fails/low confidence)
- **Impact Agent:** Parallel execution with full research at DELIVER phase
- **Layered Auto-Load:** AGENTS.md → maestro-core → Conductor → handoff operations (defense in depth for hookless agents)
- **Workflow-Aware Continuity:** Handoffs tied to entry points (`ds`, `/conductor-implement`, `/conductor-finish`) not generic session events
- **6 Handoff Triggers:** design-end, epic-start, epic-end, pre-finish, manual, idle - each fires at specific integration points
- **Hybrid Handoff Files:** Individual files per handoff (`YYYY-MM-DD_HH-MM-SS-mmm_<track>_<trigger>.md`) + index.md for consolidated log
- **5 Validation Gates:** design (DELIVER) → spec (newtrack) → plan-structure (newtrack) → plan-execution (TDD) → completion (finish)
- **Gate Behavior Matrix:** SPEED mode = all WARN; FULL mode = design/plan-execution/completion HALT + retry (max 2)
- **Validation State in metadata.json:** Track gates_passed, current_gate, retries, last_failure in metadata.json.validation
- **Humanlayer Format:** Gates use Initial Setup → 3-step Validation Process → Guidelines → Checklist → Handoff Integration
- **Wave Execution:** Auto-orchestration uses re-dispatch loop - after wave N workers complete, query `bd ready --json` and spawn wave N+1 for newly-unblocked beads until no more ready beads exist
- **Parallel Wave Execution:** Spawn independent tracks in waves, monitor Agent Mail for completion, re-dispatch when dependencies met
- **5-Category Agent Directory:** research/ review/ planning/ execution/ debug/ under skills/orchestrator/agents/
- **Mandatory send_message():** All sub-agents MUST call send_message() before returning with Status/Files/Decisions/Issues format
- **First-Message Context Load:** fetch_inbox() on session start to load prior context without hooks (Amp-specific)
- **Thin Router Pattern:** Main thread only routes and displays summaries, sub-agents do actual work and report via Agent Mail
