description = "Complete a track - extract learnings, refresh context, and archive"
prompt = """
## 0.0 PHASE 0: VALIDATION PRE-FLIGHT
**PROTOCOL: Check for resume state and validate track integrity.**

1. **Check for Existing State:**
   - Look for `conductor/tracks/<track_id>/finish-state.json`
   - If found and valid:
     ```
     Previous run interrupted at Phase X. Resume? [Y/n]
     ```
     - **Y**: Continue from saved phase
     - **N**: Delete state file and restart from Phase 1
   - If found but corrupted:
     ```
     State file corrupted. Restarting from Phase 1.
     ```

2. **Track Validation:**
   - Verify `spec.md` exists (warn if missing: "No spec.md - skipping product.md update")
   - Verify `plan.md` exists (warn if missing)
   - Check for open beads: `bd list --labels "track:<track_id>" --status open`
   - If open beads found: "⚠ X beads still open. Continue? [Y/n]"

3. **Create State File:**
   If no existing state, create `finish-state.json`:
   ```json
   {
     "trackId": "<track_id>",
     "phase": 0,
     "startedAt": "<ISO timestamp>",
     "completed": ["pre-flight"],
     "skipCodemaps": false,
     "skipRefresh": false
   }
   ```

4. **Parse Flags:**
   - `--with-pr`: Set flag for Phase 6 chaining
   - `--skip-codemaps`: Set `skipCodemaps: true`
   - `--skip-refresh`: Set `skipRefresh: true`

---

## 1.0 PHASE 1: THREAD COMPACTION
**PROTOCOL: Extract learnings from work threads.**

1. **Thread Discovery (Fallback Chain):**
   a. Check beads comments: `bd comments <id> --json` → parse `THREAD: <url>`
   b. Check `metadata.json` for `threadIds` array
   c. Use `find_thread file:<changed-files>`
   d. If none found: Log warning, skip to Phase 2

2. **Extraction:**
   For each thread, use `read_thread`:
   ```
   read_thread(
     threadID: "T-xxx",
     goal: "Extract: commands, gotchas, patterns, decisions"
   )
   ```

3. **Write LEARNINGS.md:**
   Create `conductor/tracks/<id>/LEARNINGS.md`:
   ```markdown
   # Learnings: <track_id>
   
   <!-- Auto-generated by /conductor-finish -->
   
   ## Commands
   
   ## Gotchas
   
   ## Patterns
   
   ---
   **Source threads:**
   - T-xxx: description
   ```

4. **Update State:**
   Add `"thread-compaction"` to completed array.

5. **Progress:**
   ```
   Phase 1/6: Extracting from N threads...
     → LEARNINGS.md: +X lines
   ```

---

## 2.0 PHASE 2: BEADS COMPACTION
**PROTOCOL: Generate AI summaries for closed issues.**

1. **Find Candidates:**
   ```bash
   bd compact --analyze --json
   ```

2. **Generate Summaries:**
   For each candidate:
   - Read issue content (title, description, notes)
   - Generate concise summary
   - Apply: `bd compact --apply --id <id> --summary "<text>"`

3. **Smart Skip:**
   If no candidates: "No beads need compaction. Skipping Phase 2."

4. **Update State:**
   Add `"beads-compaction"` to completed array.
   Set `beadsCompacted` count.

5. **Progress:**
   ```
   Phase 2/6: Compacting N beads...
     → N summaries applied
   ```

---

## 3.0 PHASE 3: KNOWLEDGE MERGE
**PROTOCOL: Dedupe and merge learnings into conductor/AGENTS.md**

**CRITICAL: If this phase fails, STOP WORKFLOW. Do not proceed to Phase 4.**

1. **Parse LEARNINGS.md:**
   Extract sections: Commands, Gotchas, Patterns

2. **Check Target File:**
   If `conductor/AGENTS.md` doesn't exist, create with template:
   ```markdown
   <!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->
   
   # Conductor Learnings
   
   ## Commands
   
   ## Gotchas
   
   ## Patterns
   ```

3. **Deduplication:**
   Before adding each item:
   - Check if similar content exists (fuzzy match)
   - Skip duplicates
   - Merge related items if appropriate

4. **User Review:**
   Show diff: `git diff -- "conductor/AGENTS.md"`
   Ask: "Review changes? [Y/n]"

5. **Update State:**
   Add `"knowledge-merge"` to completed array.
   Set `learningsAdded` count.

6. **Progress:**
   ```
   Phase 3/6: Merging to conductor/AGENTS.md...
     → +N lines (X commands, Y gotchas)
   ```

---

## 4.0 PHASE 4: CONTEXT REFRESH
**PROTOCOL: Update conductor context documents with shipped work.**

**Skip if `--skip-refresh` flag provided:**
```
Phase 4/6: Skipped (--skip-refresh)
```

### 4.1 Update product.md
1. Read track's `spec.md`, extract feature description
2. Read `conductor/product.md`
3. Find completion section (search: "Shipped", "Completed", "Done", "Features")
4. If none found: append `## Shipped Features`
5. Check if track already documented (by ID or title)
6. If not documented, append entry:
   ```markdown
   - [track_id] Feature description (completed YYYY-MM-DD)
   ```

### 4.2 Update tech-stack.md (detect + prompt)
1. Detect package manager(s): package.json, go.mod, requirements.txt, etc.
2. Parse current dependencies
3. Compare against documented deps in `tech-stack.md`
4. If new deps found:
   ```
   New dependencies detected:
   + dependency-name (dev/prod)
   
   Add to tech-stack.md? [Y/n]
   ```
5. Only write on user confirmation
6. Skip silently if no new deps

### 4.3 Update tracks.md
1. Read `conductor/tracks.md`
2. Find track entry by ID in "## Active Tracks" section
3. If not found: warn, continue
4. If found:
   - Remove entry from Active section
   - Add to "## Completed Tracks" section
   - Change marker: `[ ]` or `[~]` → `[x]`
   - If Archive chosen later: update link `tracks/` → `archive/`

### 4.4 Update workflow.md (detect changes)
1. Scan `.github/workflows/` for CI/CD changes
2. Detect new linting/testing tools
3. Compare against `workflow.md`
4. If changes found, prompt user to update

**Update State:**
Add `"context-refresh"` to completed array.
Update `contextRefresh` object with sub-phase status.

**Progress:**
```
Phase 4/6: Refreshing context docs...
  → product.md: +1 shipped feature
  → tech-stack.md: skipped (no new deps)
  → tracks.md: moved to Completed
  → workflow.md: skipped (no changes)
```

---

## 5.0 PHASE 5: ARCHIVE
**PROTOCOL: Prompt for archive choice and finalize.**

1. **Show Git Diff:**
   ```bash
   git diff -- "conductor/"
   ```
   Ask: "Review changes? [Y/n]"

2. **Archive Choice (A/K):**
   ```
   Archive choice:
   [A] Archive - move to conductor/archive/
   [K] Keep - stay active in tracks/
   > 
   ```

3. **Handle Choice:**
   - **A (Archive):**
     - Check if `conductor/archive/<track_id>` exists
     - If exists: Prompt "Overwrite / Rename with suffix / Abort"
     - Move track folder to `conductor/archive/`
     - Update links in tracks.md
   - **K (Keep):**
     - No folder movement
     - Track stays in `tracks/`

4. **Update metadata.json:**
   Add docSync record with archiveChoice.

5. **Commit:**
   ```bash
   git add conductor/ skills/ .beads/
   git commit -m "complete(<track_id>): N learnings extracted"
   ```

6. **Beads Cleanup:**
   ```bash
   bd count --status closed --json
   ```
   If count > 150:
   ```bash
   excess=$((closed_count - 150))
   bd cleanup --older-than 0 --limit "$excess" --force
   ```

7. **Update State:**
   Add `"archive"` to completed array.
   Set `archiveChoice` and `commitSha`.

8. **Progress:**
   ```
   Phase 5/6: Preparing archive...
   ✓ Track archived. Commit: abc1234
   ```

---

## 6.0 PHASE 6: CODEMAPS REGENERATION
**PROTOCOL: Update architecture documentation.**

**Skip if `--skip-codemaps` flag or no CODEMAPS exist:**
```
Phase 6/6: Skipped (--skip-codemaps)
```
or
```
No CODEMAPS found. Skipping Phase 6.
Run /conductor-setup to generate initial CODEMAPS.
```

1. **Check for User Modifications:**
   - Read `conductor/CODEMAPS/.meta.json`
   - Compare file mtimes to `generated` timestamp
   - If user-modified files found:
     ```
     ⚠ User-modified CODEMAPS files detected:
       - overview.md (modified 2025-12-24)
     
     Overwrite? [Y/n]
     ```
   - If user declines, skip regeneration

2. **Regenerate:**
   - Analyze current project structure
   - Regenerate `overview.md`
   - Regenerate module codemaps for significant areas
   - Update `.meta.json` with new timestamp

3. **Update State:**
   Add `"codemaps"` to completed array.

4. **Progress:**
   ```
   Phase 6/6: Regenerating CODEMAPS...
     → overview.md: updated
     → skills.md: updated
   ```

---

## 7.0 COMPLETION
**PROTOCOL: Clean up and announce success.**

1. **Delete State File:**
   Remove `conductor/tracks/<track_id>/finish-state.json`

2. **Chain to PR (if --with-pr):**
   If `--with-pr` flag was provided:
   - Load `finishing-a-development-branch` skill
   - Pass track context
   - Let skill handle PR creation

3. **Final Announcement:**
   ```
   ✓ Track completed.
   
   Summary:
   - Threads processed: N
   - Beads compacted: N
   - Learnings added: N
   - Archive choice: Archive/Keep
   - Commit: abc1234
   ```

---

## ERROR HANDLING

| Phase | On Failure | Action |
|-------|------------|--------|
| Phase 1 | Thread read fails | Log warning, skip thread, continue |
| Phase 2 | bd compact fails | Log warning, skip issue, continue |
| Phase 3 | Merge fails | **STOP WORKFLOW** |
| Phase 4 | File update fails | Report error, suggest manual fix |
| Phase 5 | Commit fails | Report error, suggest manual fix |
| Phase 6 | Regeneration fails | Log warning, continue to completion |
"""
