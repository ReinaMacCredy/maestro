# /conductor-finish Workflow

Complete a track by extracting learnings, compacting beads, and archiving.

## Trigger

**Manual:**

```
/conductor-finish <track_id>
/conductor-finish              # uses active track
```

**Auto-trigger:** When all epics closed + all beads resolved, prompt user:

```
Track ready. Run `/conductor-finish`?
```

**Flags:**

- `--with-pr` - Chain to finish-branch skill after Phase 7
- `--skip-codemaps` - Skip CODEMAPS regeneration (Phase 6)
- `--skip-doc-sync` - Skip doc-sync (Phase 7)
- `--skip-refresh` - Skip Context Refresh (Phase 4)
- `--keep` - Keep track in `tracks/` instead of auto-archiving

## Validation

Before running phases, check:

1. Open beads under this track
2. Incomplete epics in plan.md

If issues found:

```
‚ö† 2 beads still open. Continue? (y/n)
```

Never block, only warn.

---

## Phase 0: Validation Pre-Flight

**Purpose:** Check for stale state files, validate track integrity, and run completion validation gate before running phases.

### Validation Gate: validate-completion

**Before any other pre-flight checks**, run completion validation:

1. **Load gate**: `validation/shared/validate-completion.md`
2. **Run validation**: Check all beads closed, plan complete, git clean, docs updated
3. **Update LEDGER**: Add `completion` to `validation.gates_passed` or log failure
4. **Behavior by mode**:
   - **SPEED mode**: WARN on failure, continue with pre-flight
   - **FULL mode**: HALT on failure, retry up to 2x, then escalate

```
‚îå‚îÄ VALIDATION GATE: completion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Status: ‚úÖ READY | ‚ö†Ô∏è WARN | ‚ùå NOT READY      ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ Beads: 12 closed, 0 open, 0 in_progress        ‚îÇ
‚îÇ Plan: All phases [x]                           ‚îÇ
‚îÇ Git: No uncommitted changes                    ‚îÇ
‚îÇ Docs: README, CHANGELOG updated                ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ LEDGER: gates_passed: [..., completion]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

See [validate-completion.md](validation/shared/validate-completion.md) for full validation process.

### Resume Detection

1. Check for existing `finish-state.json` in track directory
2. If found and valid:

   ```
   Previous run interrupted at Phase X. Resume? [Y/n]
   ```

   - **Y**: Continue from saved phase
   - **N**: Delete state file and restart from Phase 1

3. If found but corrupted:
   ```
   State file corrupted. Restarting from Phase 1.
   ```
   Delete corrupted file and proceed.

### Track Validation

Before proceeding, verify track integrity:

| Check            | Action if Missing                                          |
| ---------------- | ---------------------------------------------------------- |
| `spec.md` exists | Warn: "No spec.md - skipping product.md update in Phase 4" |
| `plan.md` exists | Warn: "No plan.md found"                                   |
| Open beads exist | Warn: "X beads still open. Continue? [Y/n]"                |
| Incomplete epics | Warn: "X epics incomplete. Continue? [Y/n]"                |

Never block on validation failures - warn and ask to continue.

### State File Creation

If no existing state file, create `finish-state.json`:

```json
{
  "trackId": "<track_id>",
  "phase": 0,
  "startedAt": "<ISO timestamp>",
  "completed": ["pre-flight"],
  "skipCodemaps": false,
  "skipRefresh": false
}
```

### Progress

```
Phase 0/6: Pre-flight validation...
  ‚Üí Track integrity: ‚úì
  ‚Üí No stale state file
```

---

## Phase 1: Thread Compaction

**Purpose:** Extract learnings from work threads into LEARNINGS.md

### Thread Discovery (Fallback Chain)

1. **Beads comments:** `bd comments <id> --json` ‚Üí parse `THREAD: <url>`
2. **metadata.json:** Check `threadIds` array
3. **find_thread:** `find_thread file:<changed-files>`
4. **Skip:** If none found, log warning and proceed to Phase 2

### Extraction

For each thread, use `read_thread`:

```
read_thread(
  threadID: "T-xxx",
  goal: "Extract: commands, gotchas, patterns, decisions"
)
```

### Output

Write `conductor/tracks/<id>/LEARNINGS.md`:

```markdown
# Learnings: {{track_id}}

<!-- Auto-generated by /conductor-finish -->

## Commands

<!-- CLI commands discovered -->

## Gotchas

<!-- Pitfalls, edge cases, warnings -->

## Patterns

<!-- Reusable patterns (optional) -->

---

**Source threads:**

- T-xxx: description
```

### Progress

```
Phase 1/6: Extracting from 3 threads...
  ‚Üí LEARNINGS.md: +12 lines
```

### Smart Skip

If no threads found: `"No threads found. Skipping Phase 1."`

---

## Phase 2: Beads Compaction

**Purpose:** Generate AI summaries for closed issues

### Find Candidates

```bash
bd compact --analyze --json
```

### Generate Summaries

For each candidate:

1. Read issue content (title, description, notes)
2. Generate concise summary
3. Apply: `bd compact --apply --id <id> --summary "<text>"`

### Progress

```
Phase 2/6: Compacting 5 beads...
  ‚Üí 5 summaries applied
```

### Smart Skip

If no candidates: `"No beads need compaction. Skipping Phase 2."`

---

## Phase 3: Knowledge Merge

**Purpose:** Dedupe and merge learnings into conductor/AGENTS.md

### Parse LEARNINGS.md

Extract sections:

- Commands
- Gotchas
- Patterns

### Target File

Check `conductor/AGENTS.md` exists. If not, create with template:

```markdown
<!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->

# Conductor Learnings

Knowledge extracted from completed tracks.

## About This File

This file is auto-updated by `/conductor-finish`.
Contains reusable learnings from completed tracks.

**Do not edit manually** - changes may be overwritten.

---

## Commands

## Gotchas

## Patterns
```

### Deduplication

Before adding each item:

1. Check if similar content exists (fuzzy match)
2. Skip duplicates
3. Merge related items if appropriate

### Selective Sync

Only sync these sections:

- Commands ‚Üí Commands
- Gotchas ‚Üí Gotchas
- Patterns ‚Üí Patterns

### User Review

Show diff:

```bash
git diff -- "conductor/AGENTS.md"
```

Ask: `Review changes? [Y/n]`

### Progress

```
Phase 3/6: Merging to conductor/AGENTS.md...
  ‚Üí +5 lines (2 commands, 1 gotcha)
```

### Required Phase

If Phase 3 fails, stop workflow. Do not proceed to Phase 4.

---

## Phase 4: Context Refresh

**Purpose:** Update conductor context documents with shipped work.

### Skip Flag

If `--skip-refresh` provided:

```
Phase 4/6: Skipped (--skip-refresh)
```

Proceed directly to Phase 5.

### 4.1 Update product.md

1. Read track's `spec.md`, extract feature/bugfix description
2. If no `spec.md`: warn "No spec.md - skipping product.md update", skip to 4.2
3. Read `conductor/product.md`
4. Find existing completion section by searching headings for:
   - "Shipped"
   - "Completed"
   - "Done"
   - "Features"
5. If no matching section found: append `## Shipped Features` at end
6. Check if track already documented (by ID or title) - skip if found (idempotent)
7. Append entry:
   ```markdown
   - [track_id] Feature description (completed YYYY-MM-DD)
   ```

### 4.2 Update tech-stack.md (detect + prompt)

1. Detect package manager(s) in project:
   - `package.json` / `package-lock.json` / `yarn.lock` / `pnpm-lock.yaml`
   - `go.mod` / `go.sum`
   - `requirements.txt` / `pyproject.toml`
   - `Cargo.toml` / `Cargo.lock`
2. Parse current dependencies from manifest/lockfile
3. Compare against documented deps in `conductor/tech-stack.md`
4. If new deps found:

   ```
   New dependencies detected:
   + @types/node (dev)
   + zod

   Add to tech-stack.md? [Y/n]
   ```

5. On confirm: append to appropriate section
6. On decline or no new deps: skip silently

### 4.3 Update tracks.md

1. Read `conductor/tracks.md`
2. Find track entry by ID in "## Active Tracks" section (or similar active heading)
3. If not found: warn "Track entry not found in tracks.md", continue to 4.4
4. If found:
   - Remove entry from Active section
   - Add to "## Completed Tracks" section (create if missing)
   - Change marker: `[ ]` or `[~]` ‚Üí `[x]`
   - If Archive chosen in Phase 5: update link `tracks/` ‚Üí `archive/`

### 4.4 Update workflow.md (detect changes)

1. Scan `.github/workflows/` for CI/CD file changes
2. Detect new linting/testing tools in project
3. Compare against `conductor/workflow.md`
4. If changes found:

   ```
   CI/CD changes detected:
   + New workflow: release.yml
   + Testing tool: vitest

   Update workflow.md? [Y/n]
   ```

5. On confirm: update relevant sections
6. On decline or no changes: skip silently

### Progress

```
Phase 4/6: Refreshing context docs...
  ‚Üí product.md: +1 shipped feature
  ‚Üí tech-stack.md: skipped (no new deps)
  ‚Üí tracks.md: moved to Completed
  ‚Üí workflow.md: skipped (no changes)
```

### State Update

Update `finish-state.json`:

```json
{
  "phase": 4,
  "completed": [
    "pre-flight",
    "thread-compaction",
    "beads-compaction",
    "knowledge-merge",
    "context-refresh"
  ],
  "contextRefresh": {
    "productMd": "updated",
    "techStackMd": "no-new-deps",
    "tracksMd": "updated",
    "workflowMd": "no-changes"
  }
}
```

---

## Phase 5: Archive

**Purpose:** Archive track, commit changes, cleanup beads

### Auto-Archive (Default)

By default, tracks are automatically archived without prompting:

1. Move track folder to `conductor/archive/`
2. Update links in `tracks.md`
3. Set `"archiveChoice": "archive"` in `metadata.json` and `finish-state.json`

### Keep Flag

Use `--keep` flag to skip archiving:

```
/conductor-finish --keep
```

This keeps the track in `tracks/` without moving to archive.

### Folder Conflict Handling

If `conductor/archive/<track_id>/` already exists:

```
Archive folder already exists. Choose:
[O] Overwrite - replace existing archive
[R] Rename - archive as <track_id>_1
[A] Abort - cancel archive
>
```

### Update metadata.json

Add docSync record:

```json
{
  "docSync": {
    "at": "2025-12-23T10:30:00Z",
    "threads": ["T-abc123"],
    "itemsAdded": 3,
    "archiveChoice": "archive"
  }
}
```

Valid `archiveChoice` values: `"archive"` or `"keep"`.

### Commit

Single commit with all changes:

```bash
git add conductor/ skills/
git commit -m "complete(track_id): N learnings extracted"
```

Note: `.beads/` is gitignored at the project root. Beads changes are committed separately via `bd sync`.

### Beads Cleanup

Check closed count:

```bash
bd count --status closed --json
```

If count > 150:

```bash
excess=$((closed_count - 150))
bd cleanup --older-than 0 --limit "$excess" --force
```

### Progress

```
Phase 5/6: Preparing archive...

‚úì Track archived. Commit: abc123
```

---

## Phase 6: CODEMAPS Regeneration

**Purpose:** Update architecture documentation to reflect code changes from this track

### Skip Check

If `--skip-codemaps` flag provided:

```
Phase 6/6: Skipped (--skip-codemaps)
```

Proceed directly to completion.

### User Modification Check

1. Read `conductor/CODEMAPS/.meta.json`
2. For each file in `.meta.json.files`:

   - Get file mtime from filesystem
   - Compare to `.meta.json.generated` timestamp
   - If file mtime > generated timestamp, set `user_modified: true`

3. If any files have `user_modified: true`:

```
‚ö† User-modified CODEMAPS files detected:
  - overview.md (modified 2025-12-24)
  - skills.md (modified 2025-12-24)

Overwrite? [Y/n]
```

If user declines, skip regeneration.

### Regeneration

1. Analyze current project structure (same as `/conductor-setup` Phase 7)
2. Regenerate `overview.md` (always)
3. Regenerate module codemaps for significant areas
4. Update `.meta.json`:
   ```json
   {
     "generated": "<new ISO timestamp>",
     "generator": "/conductor-finish",
     "project_type": "<detected type>",
     "files": {
       "overview.md": { "generated": true, "user_modified": false },
       ...
     }
   }
   ```

### Scale Limits

Same as `/conductor-setup`:

- Directory depth: Top 2 levels only
- Key files per codemap: Max 50 files
- Module codemaps: Max 10 files

### Progress

```
Phase 6/6: Regenerating CODEMAPS...
  ‚Üí overview.md: updated
  ‚Üí skills.md: updated
  ‚Üí .meta.json: updated
```

### Smart Skip

If no `conductor/CODEMAPS/` exists:

```
No CODEMAPS found. Skipping Phase 6.
Run /conductor-setup to generate initial CODEMAPS.
```

---

## Phase 6.5: Continuity Handoff

**Purpose:** Create handoff for track completion and clean up session state.

### Trigger Conditions

Run Phase 6.5 when track is being archived (archiveChoice = "archive").

### Workflow

1. **Create Handoff**
   - Run `continuity handoff track-complete`
   - Creates archived handoff: `conductor/sessions/archive/YYYY-MM-DD-HH-MM-track-complete.md`
   - Includes: track summary, key decisions, learnings reference

2. **Clear LEDGER Binding**
   - Update LEDGER.md frontmatter:
     ```yaml
     bound_track: null
     bound_bead: null
     tdd_phase: null
     ```
   - Keep `mode` and `session_id` for continuity

3. **Archive LEDGER (if archive chosen)**
   - If user chose Archive in Phase 5:
     - Copy LEDGER.md content to handoff archive
     - Delete `conductor/sessions/active/LEDGER.md`
   - If user chose Keep:
     - Clear bindings only, keep LEDGER.md active

### Progress

```
Phase 6.5: Continuity handoff...
  ‚Üí Handoff created: 2025-12-27-14-30-track-complete.md
  ‚Üí LEDGER.md: bindings cleared
```

### Skip Check

If `archiveChoice = "keep"`:
- Clear bindings only
- Do not delete LEDGER.md
- Do not create track-complete handoff

---

## Resume Capability

### State File

Schema: `skills/conductor/references/schemas/finish_state.schema.json`

Create `finish-state.json` at workflow start:

```json
{
  "trackId": "auth-v2_20251223",
  "phase": 0,
  "startedAt": "2025-12-23T10:30:00Z",
  "completed": [],
  "skipCodemaps": false,
  "skipRefresh": false
}
```

Update after each phase:

```json
{
  "trackId": "auth-v2_20251223",
  "phase": 4,
  "startedAt": "2025-12-23T10:30:00Z",
  "completed": [
    "pre-flight",
    "thread-compaction",
    "beads-compaction",
    "knowledge-merge"
  ],
  "skipCodemaps": false,
  "skipRefresh": false,
  "contextRefresh": {
    "productMd": "updated",
    "techStackMd": "no-new-deps",
    "tracksMd": "pending",
    "workflowMd": "pending"
  },
  "threadsProcessed": ["T-abc123", "T-def456"],
  "beadsCompacted": 5,
  "learningsAdded": 3
}
```

### Resume Prompt

On re-run with existing finish-state.json:

```
Previous run interrupted at Phase 3. Resume? [Y/n]
```

### Cleanup

Delete `finish-state.json` on successful completion.

### Corrupted State

If finish-state.json is invalid/corrupted:

```
State file corrupted. Restarting from Phase 1.
```

---

## Error Handling

| Phase   | On Failure                  | Action                              |
| ------- | --------------------------- | ----------------------------------- |
| Phase 1 | Thread read fails           | Log warning, skip thread, continue  |
| Phase 2 | bd compact fails            | Log warning, skip issue, continue   |
| Phase 3 | Merge fails                 | **Stop workflow**                   |
| Phase 4 | Context refresh fails       | Report error, suggest manual fix    |
| Phase 5 | Archive/commit fails        | Report error, suggest manual fix    |
| Phase 6 | CODEMAPS regeneration fails | Log warning, continue to completion |

---

## Full Progress Example

```
/conductor-finish changelog-cicd

Validating track... ‚úì
  ‚ö† 2 beads still open. Continue? (y/n) y

Phase 1/6: Extracting from 3 threads...
  ‚Üí LEARNINGS.md: +12 lines
Phase 2/6: Compacting 5 beads...
  ‚Üí 5 summaries applied
Phase 3/6: Merging to conductor/AGENTS.md...
  ‚Üí +5 lines (2 commands, 1 gotcha)
Phase 4/6: Refreshing context docs...
  ‚Üí product.md: +1 shipped feature
  ‚Üí tech-stack.md: skipped (no new deps)
  ‚Üí tracks.md: moved to Completed
  ‚Üí workflow.md: skipped (no changes)
Phase 5/6: Archiving track...
  ‚Üí Moved to conductor/archive/
Phase 6/6: Regenerating CODEMAPS...
  ‚Üí overview.md: updated
  ‚Üí skills.md: updated

‚úì Track completed. Commit: abc123
```

---

## Phase 7: Doc-Sync

**Purpose:** Synchronize documentation with code changes from this track

### Skip Check

If `--skip-doc-sync` flag provided:

```
Phase 7: Skipped (--skip-doc-sync)
```

Proceed directly to completion.

### Trigger Conditions

Run Phase 7 when ALL of:
- Phase 6 (CODEMAPS) completed successfully
- Project has `.md` files with code references
- `--skip-doc-sync` flag NOT passed

### Skip Conditions

Skip Phase 7 if ANY of:
- `--skip-doc-sync` flag passed
- No markdown files found in project
- No code changes detected in track
- Track is documentation-only (no code files changed)

### Workflow

1. **Scan** - Find `.md` files with code references
2. **Detect** - Get code changes from git diff + beads
3. **Update** - Auto-apply minor, prompt for major

### Progress

```
Phase 7: Doc-Sync
  üìÑ Scanning docs... 5 found
  üìä Detecting changes... 3 found
  ‚úÖ Auto-updated: 2 path changes
  ‚ùì New feature detected: Add section to README.md? [Y/n] Y
  ‚úÖ Added section
Phase 7: Doc-Sync ‚úÖ
```

### Error Handling

Doc-sync errors are **non-blocking**:

```
‚ö†Ô∏è  Phase 7 (Doc-Sync) encountered errors:
    - README.md: Could not parse code block at line 45
    
Continuing to completion...
```

### State Update

Update `finish-state.json`:

```json
{
  "phase": 7,
  "completed": [..., "doc-sync"],
  "docSync": {
    "filesScanned": 5,
    "minorUpdates": 2,
    "majorUpdates": 1
  }
}
```

See [doc-sync skill](../../doc-sync/SKILL.md) for full documentation.

---

## Optional: --with-pr

When `--with-pr` flag provided:

After Phase 6 completes, chain to `finishing-a-development-branch` skill:

1. Pass track context
2. Let skill handle PR creation options
3. Report final status

---

## Edge Cases

| Case                                  | Handling                                                                    |
| ------------------------------------- | --------------------------------------------------------------------------- |
| Track has no beads                    | Skip Phase 2, log warning                                                   |
| Track has no threads                  | Fallback chain ‚Üí skip Phase 1                                               |
| Fresh repo (no conductor/AGENTS.md)   | Create with template                                                        |
| finish-state.json corrupted           | Delete and restart from Phase 1                                             |
| User runs finish twice                | Idempotent - safe to re-run                                                 |
| Open beads/epics                      | Warn, ask to continue                                                       |
| Git dirty state                       | Warn user, ask to stash or continue                                         |
| No conductor/CODEMAPS/                | Skip Phase 6, suggest running later                                         |
| User-modified CODEMAPS files          | Warn, ask to overwrite                                                      |
| --skip-codemaps flag                  | Skip Phase 6 entirely                                                       |
| --skip-refresh flag                   | Skip Phase 4 entirely                                                       |
| Track has no spec.md                  | Warn, skip product.md update                                                |
| product.md missing completion section | Search for "Shipped"/"Completed"/"Done"/"Features", else append new section |
| Track already in Completed section    | Skip (idempotent)                                                           |
| Archive folder already exists         | Prompt: overwrite/rename/abort                                              |
| tracks.md entry not found             | Warn, continue without tracks.md update                                     |
