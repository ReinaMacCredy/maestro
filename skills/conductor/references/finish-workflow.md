# /conductor-finish Workflow

Complete a track by extracting learnings, compacting beads, and archiving.

## Trigger

**Manual:**
```
/conductor-finish <track_id>
/conductor-finish              # uses active track
```

**Auto-trigger:** When all epics closed + all beads resolved, prompt user:
```
Track ready. Run `/conductor-finish`?
```

**Flags:**
- `--with-pr` - Chain to finish-branch skill after Phase 5
- `--skip-codemaps` - Skip CODEMAPS regeneration (Phase 5)

## Validation

Before running phases, check:
1. Open beads under this track
2. Incomplete epics in plan.md

If issues found:
```
⚠ 2 beads still open. Continue? (y/n)
```

Never block, only warn.

---

## Phase 1: Thread Compaction

**Purpose:** Extract learnings from work threads into LEARNINGS.md

### Thread Discovery (Fallback Chain)

1. **Beads comments:** `bd comments <id> --json` → parse `THREAD: <url>`
2. **metadata.json:** Check `threadIds` array
3. **find_thread:** `find_thread file:<changed-files>`
4. **Skip:** If none found, log warning and proceed to Phase 2

### Extraction

For each thread, use `read_thread`:
```
read_thread(
  threadID: "T-xxx",
  goal: "Extract: commands, gotchas, patterns, decisions"
)
```

### Output

Write `conductor/tracks/<id>/LEARNINGS.md`:
```markdown
# Learnings: {{track_id}}

<!-- Auto-generated by /conductor-finish -->

## Commands
<!-- CLI commands discovered -->

## Gotchas
<!-- Pitfalls, edge cases, warnings -->

## Patterns
<!-- Reusable patterns (optional) -->

---
**Source threads:**
- T-xxx: description
```

### Progress
```
Phase 1/5: Extracting from 3 threads...
  → LEARNINGS.md: +12 lines
```

### Smart Skip
If no threads found: `"No threads found. Skipping Phase 1."`

---

## Phase 2: Beads Compaction

**Purpose:** Generate AI summaries for closed issues

### Find Candidates

```bash
bd compact --analyze --json
```

### Generate Summaries

For each candidate:
1. Read issue content (title, description, notes)
2. Generate concise summary
3. Apply: `bd compact --apply --id <id> --summary "<text>"`

### Progress
```
Phase 2/5: Compacting 5 beads...
  → 5 summaries applied
```

### Smart Skip
If no candidates: `"No beads need compaction. Skipping Phase 2."`

---

## Phase 3: Knowledge Merge

**Purpose:** Dedupe and merge learnings into conductor/AGENTS.md

### Parse LEARNINGS.md

Extract sections:
- Commands
- Gotchas
- Patterns

### Target File

Check `conductor/AGENTS.md` exists. If not, create with template:
```markdown
<!-- AUTO-GENERATED by /conductor-finish. Do not edit manually. -->

# Conductor Learnings

Knowledge extracted from completed tracks.

## About This File

This file is auto-updated by `/conductor-finish`.
Contains reusable learnings from completed tracks.

**Do not edit manually** - changes may be overwritten.

---

## Commands

## Gotchas

## Patterns
```

### Deduplication

Before adding each item:
1. Check if similar content exists (fuzzy match)
2. Skip duplicates
3. Merge related items if appropriate

### Selective Sync

Only sync these sections:
- Commands → Commands
- Gotchas → Gotchas
- Patterns → Patterns

### User Review

Show diff:
```bash
git diff -- "conductor/AGENTS.md"
```

Ask: `Review changes? [Y/n]`

### Progress
```
Phase 3/5: Merging to conductor/AGENTS.md...
  → +5 lines (2 commands, 1 gotcha)
```

### Required Phase
If Phase 3 fails, stop workflow. Do not proceed to Phase 4.

---

## Phase 4: Archive

**Purpose:** Archive track, commit changes, cleanup beads

### Archive Choice (S/H/K)

Prompt user:
```
Archive choice:
[S] Soft - keep in tracks/, mark archived in metadata
[H] Hard - move to conductor/archive/ now
[K] Keep - don't archive, stay active
> 
```

| Choice | Action |
|--------|--------|
| **S** | Set `metadata.json` status = "archived", keep in tracks/ |
| **H** | Move track folder to `conductor/archive/` |
| **K** | No change, track stays active |

### Update metadata.json

Add docSync record:
```json
{
  "docSync": {
    "at": "2024-12-23T10:30:00Z",
    "threads": ["T-abc123"],
    "itemsAdded": 3,
    "archiveChoice": "soft"
  }
}
```

### Commit

Single commit with all changes:
```bash
git add conductor/ skills/ .beads/
git commit -m "complete(track_id): N learnings extracted"
```

### Beads Cleanup

Check closed count:
```bash
bd count --status closed --json
```

If count > 150:
```bash
excess=$((closed_count - 150))
bd cleanup --older-than 0 --limit "$excess" --force
```

### Progress
```
Phase 4/5: Preparing archive...
  
✓ Track archived. Commit: abc123
```

---

## Phase 5: CODEMAPS Regeneration

**Purpose:** Update architecture documentation to reflect code changes from this track

### Skip Check

If `--skip-codemaps` flag provided:
```
Phase 5/5: Skipped (--skip-codemaps)
```

Proceed directly to completion.

### User Modification Check

1. Read `conductor/CODEMAPS/.meta.json`
2. For each file in `.meta.json.files`:
   - Get file mtime from filesystem
   - Compare to `.meta.json.generated` timestamp
   - If file mtime > generated timestamp, set `user_modified: true`

3. If any files have `user_modified: true`:
```
⚠ User-modified CODEMAPS files detected:
  - overview.md (modified 2024-12-24)
  - skills.md (modified 2024-12-24)

Overwrite? [Y/n]
```

If user declines, skip regeneration.

### Regeneration

1. Analyze current project structure (same as `/conductor-setup` Phase 7)
2. Regenerate `overview.md` (always)
3. Regenerate module codemaps for significant areas
4. Update `.meta.json`:
   ```json
   {
     "generated": "<new ISO timestamp>",
     "generator": "/conductor-finish",
     "project_type": "<detected type>",
     "files": {
       "overview.md": { "generated": true, "user_modified": false },
       ...
     }
   }
   ```

### Scale Limits

Same as `/conductor-setup`:
- Directory depth: Top 2 levels only
- Key files per codemap: Max 50 files
- Module codemaps: Max 10 files

### Progress
```
Phase 5/5: Regenerating CODEMAPS...
  → overview.md: updated
  → skills.md: updated
  → .meta.json: updated
```

### Smart Skip

If no `conductor/CODEMAPS/` exists:
```
No CODEMAPS found. Skipping Phase 5.
Consider running /conductor-refresh with scope codemaps.
```

---

## Resume Capability

### State File

Create `finish-state.json` at workflow start:
```json
{
  "phase": 1,
  "startedAt": "2024-12-23T10:30:00Z",
  "completed": []
}
```

Update after each phase:
```json
{
  "phase": 3,
  "startedAt": "2024-12-23T10:30:00Z",
  "completed": ["thread-compaction", "beads-compaction"],
  "skipCodemaps": false
}
```

### Resume Prompt

On re-run with existing finish-state.json:
```
Previous run interrupted at Phase 3. Resume? [Y/n]
```

### Cleanup

Delete `finish-state.json` on successful completion.

### Corrupted State

If finish-state.json is invalid/corrupted:
```
State file corrupted. Restarting from Phase 1.
```

---

## Error Handling

| Phase | On Failure | Action |
|-------|------------|--------|
| Phase 1 | Thread read fails | Log warning, skip thread, continue |
| Phase 2 | bd compact fails | Log warning, skip issue, continue |
| Phase 3 | Merge fails | **Stop workflow** |
| Phase 4 | Commit fails | Report error, suggest manual fix |
| Phase 5 | CODEMAPS regeneration fails | Log warning, continue to completion |

---

## Full Progress Example

```
/conductor-finish changelog-cicd

Validating track... ✓
  ⚠ 2 beads still open. Continue? (y/n) y

Phase 1/5: Extracting from 3 threads...
  → LEARNINGS.md: +12 lines
Phase 2/5: Compacting 5 beads...
  → 5 summaries applied
Phase 3/5: Merging to conductor/AGENTS.md...
  → +5 lines (2 commands, 1 gotcha)
Phase 4/5: Preparing archive...

Review changes? [Y/n] y
  [shows git diff]

Archive choice:
[S] Soft - keep in tracks/, cleanup later
[H] Hard - move to archive/ now
[K] Keep - don't archive yet
> S

Phase 5/5: Regenerating CODEMAPS...
  → overview.md: updated
  → skills.md: updated

✓ Track completed. Commit: abc123
```

---

## Optional: --with-pr

When `--with-pr` flag provided:

After Phase 5 completes, chain to `finishing-a-development-branch` skill:
1. Pass track context
2. Let skill handle PR creation options
3. Report final status

---

## Edge Cases

| Case | Handling |
|------|----------|
| Track has no beads | Skip Phase 2, log warning |
| Track has no threads | Fallback chain → skip Phase 1 |
| Fresh repo (no conductor/AGENTS.md) | Create with template |
| finish-state.json corrupted | Delete and restart |
| User runs finish twice | Idempotent - safe to re-run |
| Open beads/epics | Warn, ask to continue |
| Git dirty state | Warn user, ask to stash or continue |
| No conductor/CODEMAPS/ | Skip Phase 5, suggest /conductor-refresh |
| User-modified CODEMAPS files | Warn, ask to overwrite |
| --skip-codemaps flag | Skip Phase 5 entirely |
