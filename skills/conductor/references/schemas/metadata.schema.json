{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://conductor.dev/schemas/metadata.schema.json",
  "title": "Track Metadata",
  "description": "Metadata file for a Conductor track",
  "type": "object",
  "required": [
    "track_id",
    "type",
    "status",
    "created_at",
    "updated_at",
    "description",
    "priority"
  ],
  "properties": {
    "track_id": {
      "type": "string",
      "description": "Unique identifier for the track",
      "pattern": "^[a-z0-9-]+_[0-9]{8}$",
      "examples": ["user-auth_20250115", "bug-fix_20250120", "auth-v2_20251223"]
    },
    "type": {
      "type": "string",
      "description": "Type of track",
      "enum": ["feature", "bug", "chore", "refactor", "hotfix"],
      "default": "feature"
    },
    "status": {
      "type": "string",
      "description": "Current status of the track",
      "enum": [
        "new",
        "in_progress",
        "complete",
        "archived",
        "cancelled",
        "blocked"
      ],
      "default": "new"
    },
    "created_at": {
      "type": "string",
      "description": "ISO 8601 timestamp of track creation",
      "format": "date-time",
      "examples": ["2025-01-15T10:30:00Z"]
    },
    "updated_at": {
      "type": "string",
      "description": "ISO 8601 timestamp of last update",
      "format": "date-time",
      "examples": ["2025-01-15T14:45:00Z"]
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the track",
      "minLength": 1,
      "maxLength": 500
    },
    "priority": {
      "type": "string",
      "description": "Track priority level",
      "enum": ["critical", "high", "medium", "low"],
      "default": "medium"
    },
    "depends_on": {
      "type": "array",
      "items": { "type": "string" },
      "default": [],
      "description": "List of track_ids this track depends on"
    },
    "estimated_hours": {
      "type": ["number", "null"],
      "description": "Estimated hours to complete",
      "minimum": 0,
      "default": null
    },
    "has_design": {
      "type": "boolean",
      "description": "Whether this track has a design.md file",
      "default": false
    },
    "threads": {
      "type": "array",
      "description": "Amp thread IDs associated with this track for audit trail",
      "items": {
        "type": "object",
        "required": ["id", "action", "timestamp"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Thread ID (format: T-uuid)",
            "pattern": "^T-[a-f0-9-]+$"
          },
          "action": {
            "type": "string",
            "description": "What action was performed in this thread",
            "enum": ["design", "newtrack", "implement", "review", "revise"]
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When this thread was associated"
          }
        },
        "additionalProperties": false
      },
      "default": []
    },
    "artifacts": {
      "type": "object",
      "description": "Which artifacts have been created for this track",
      "properties": {
        "design": {
          "type": "boolean",
          "description": "Has design.md",
          "default": false
        },
        "spec": {
          "type": "boolean",
          "description": "Has spec.md",
          "default": false
        },
        "plan": {
          "type": "boolean",
          "description": "Has plan.md",
          "default": false
        },
        "beads": {
          "type": "boolean",
          "description": "Has beads filed",
          "default": false
        }
      },
      "additionalProperties": false,
      "default": {
        "design": false,
        "spec": false,
        "plan": false,
        "beads": false
      }
    },
    "assigned_to": {
      "type": "string",
      "description": "Person or team assigned to this track"
    },
    "parent_track_id": {
      "type": "string",
      "description": "ID of parent track if this is a sub-track",
      "pattern": "^[a-z0-9-]+_[0-9]{8}$"
    },
    "tags": {
      "type": "array",
      "description": "Optional tags for categorization",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "actual_hours": {
      "type": "number",
      "description": "Actual hours spent",
      "minimum": 0
    },
    "completed_at": {
      "type": "string",
      "description": "ISO 8601 timestamp when track was completed",
      "format": "date-time"
    },
    "cancelled_at": {
      "type": "string",
      "description": "ISO 8601 timestamp when track was cancelled",
      "format": "date-time"
    },
    "cancellation_reason": {
      "type": "string",
      "description": "Reason for cancellation if cancelled"
    },
    "repairs": {
      "type": "array",
      "description": "Log of automated repairs performed on this track",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "field": {
            "type": "string"
          },
          "action": {
            "type": "string"
          },
          "from": {
            "type": "string"
          },
          "to": {
            "type": "string"
          },
          "by": {
            "type": "string"
          }
        }
      },
      "default": []
    },
    "workflow": {
      "type": "object",
      "description": "Workflow state machine tracking for the track",
      "properties": {
        "state": {
          "type": "string",
          "description": "Current workflow state",
          "enum": ["INIT", "DESIGNED", "TRACKED", "FILED", "REVIEWED", "IMPLEMENTING", "DONE", "ARCHIVED"],
          "default": "INIT"
        },
        "history": {
          "type": "array",
          "description": "Log of state transitions",
          "items": {
            "type": "object",
            "required": ["state", "at", "command"],
            "properties": {
              "state": {
                "type": "string",
                "description": "The state transitioned to",
                "enum": ["INIT", "DESIGNED", "TRACKED", "FILED", "REVIEWED", "IMPLEMENTING", "DONE", "ARCHIVED"]
              },
              "at": {
                "type": "string",
                "format": "date-time",
                "description": "When the transition occurred"
              },
              "command": {
                "type": "string",
                "description": "The command that triggered the transition",
                "enum": ["newtrack", "ds", "fb", "rb", "implement", "finish"]
              }
            },
            "additionalProperties": false
          },
          "default": []
        },
        "branch": {
          "type": ["string", "null"],
          "description": "Git branch created via preflight (e.g., feat/track-id)",
          "default": null
        },
        "archived": {
          "type": "boolean",
          "description": "Whether the track has been archived",
          "default": false
        },
        "keep": {
          "type": "boolean",
          "description": "Whether --keep flag was used to prevent archiving",
          "default": false
        }
      },
      "additionalProperties": false,
      "default": {
        "state": "INIT",
        "history": [],
        "branch": null,
        "archived": false,
        "keep": false
      }
    },
    "generation": {
      "type": "object",
      "description": "Spec/plan generation progress (consolidated from .track-progress.json)",
      "properties": {
        "status": {
          "type": "string",
          "description": "Current generation status",
          "enum": ["initializing", "spec_done", "plan_done", "complete"],
          "default": "initializing"
        },
        "specCreatedAt": {
          "type": ["string", "null"],
          "description": "ISO 8601 timestamp when spec.md was created",
          "format": "date-time",
          "default": null
        },
        "planCreatedAt": {
          "type": ["string", "null"],
          "description": "ISO 8601 timestamp when plan.md was created",
          "format": "date-time",
          "default": null
        },
        "rbCompletedAt": {
          "type": ["string", "null"],
          "description": "ISO 8601 timestamp when review-beads (rb) completed",
          "format": "date-time",
          "default": null
        }
      },
      "additionalProperties": false,
      "default": {
        "status": "initializing",
        "specCreatedAt": null,
        "planCreatedAt": null,
        "rbCompletedAt": null
      }
    },
    "beads": {
      "type": "object",
      "description": "Beads filing state (consolidated from .fb-progress.json)",
      "properties": {
        "status": {
          "type": "string",
          "description": "Current beads filing status",
          "enum": ["pending", "in_progress", "complete", "failed"],
          "default": "pending"
        },
        "epicId": {
          "type": ["string", "null"],
          "description": "Primary epic bead ID for this track",
          "default": null
        },
        "epics": {
          "type": "array",
          "description": "List of created epics",
          "items": {
            "type": "object",
            "required": ["id", "title", "status", "createdAt"],
            "properties": {
              "id": {
                "type": "string",
                "description": "Bead ID (e.g., my-workflow:3-xyz)"
              },
              "title": {
                "type": "string",
                "description": "Epic title"
              },
              "status": {
                "type": "string",
                "enum": ["created", "filled", "complete"],
                "description": "Epic creation status"
              },
              "createdAt": {
                "type": "string",
                "format": "date-time",
                "description": "When epic was created"
              },
              "reviewed": {
                "type": "boolean",
                "description": "Whether epic has been reviewed",
                "default": false
              },
              "reviewedAt": {
                "type": ["string", "null"],
                "format": "date-time",
                "description": "When epic was reviewed",
                "default": null
              }
            },
            "additionalProperties": false
          },
          "default": []
        },
        "issues": {
          "type": "array",
          "description": "List of created issue bead IDs",
          "items": {
            "type": "string",
            "description": "Bead ID (e.g., my-workflow:3-abc)"
          },
          "default": []
        },
        "planTasks": {
          "type": "object",
          "description": "Mapping from plan task ID to bead ID",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "beadToTask": {
          "type": "object",
          "description": "Reverse mapping from bead ID to plan task ID",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "crossTrackDeps": {
          "type": "array",
          "description": "Cross-track dependencies that need manual linking",
          "items": {
            "type": "object",
            "required": ["from", "to"],
            "properties": {
              "from": {
                "type": "string",
                "description": "Source bead ID"
              },
              "to": {
                "type": "string",
                "description": "Target track:bead ID (e.g., api_20251223:bd-7)"
              }
            },
            "additionalProperties": false
          },
          "default": []
        },
        "reviewStatus": {
          "type": ["string", "null"],
          "description": "Review status from rb skill",
          "enum": ["in_progress", "complete", null],
          "default": null
        },
        "reviewedAt": {
          "type": ["string", "null"],
          "description": "ISO 8601 timestamp when review was completed",
          "format": "date-time",
          "default": null
        }
      },
      "additionalProperties": false,
      "default": {
        "status": "pending",
        "epicId": null,
        "epics": [],
        "issues": [],
        "planTasks": {},
        "beadToTask": {},
        "crossTrackDeps": [],
        "reviewStatus": null,
        "reviewedAt": null
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "track_id": "user-auth_20250115",
      "type": "feature",
      "status": "in_progress",
      "priority": "high",
      "created_at": "2025-01-15T10:30:00Z",
      "updated_at": "2025-01-15T14:45:00Z",
      "description": "Implement user authentication with JWT tokens",
      "has_design": true,
      "threads": [
        {
          "id": "T-019b4a25-c3eb-773e-ba1d-dfd80ee19092",
          "action": "design",
          "timestamp": "2025-01-15T10:30:00Z"
        },
        {
          "id": "T-019b4a26-abcd-1234-5678-901234567890",
          "action": "newtrack",
          "timestamp": "2025-01-15T11:00:00Z"
        }
      ],
      "artifacts": {
        "design": true,
        "spec": true,
        "plan": true,
        "beads": true
      },
      "workflow": {
        "state": "IMPLEMENTING",
        "history": [
          {"state": "INIT", "at": "2025-01-15T10:00:00Z", "command": "newtrack"},
          {"state": "DESIGNED", "at": "2025-01-15T10:30:00Z", "command": "ds"},
          {"state": "TRACKED", "at": "2025-01-15T11:00:00Z", "command": "newtrack"},
          {"state": "FILED", "at": "2025-01-15T11:15:00Z", "command": "fb"},
          {"state": "REVIEWED", "at": "2025-01-15T11:20:00Z", "command": "rb"},
          {"state": "IMPLEMENTING", "at": "2025-01-15T11:30:00Z", "command": "implement"}
        ],
        "branch": "feat/user-auth_20250115",
        "archived": false,
        "keep": false
      }
    },
    {
      "track_id": "login-bug_20250120",
      "type": "bug",
      "status": "complete",
      "priority": "high",
      "created_at": "2025-01-20T09:00:00Z",
      "updated_at": "2025-01-20T11:30:00Z",
      "description": "Fix login redirect loop on expired session",
      "completed_at": "2025-01-20T11:30:00Z",
      "has_design": false,
      "artifacts": {
        "design": false,
        "spec": true,
        "plan": true,
        "beads": false
      },
      "workflow": {
        "state": "ARCHIVED",
        "history": [
          {"state": "INIT", "at": "2025-01-20T09:00:00Z", "command": "newtrack"},
          {"state": "TRACKED", "at": "2025-01-20T09:30:00Z", "command": "newtrack"},
          {"state": "IMPLEMENTING", "at": "2025-01-20T10:00:00Z", "command": "implement"},
          {"state": "DONE", "at": "2025-01-20T11:00:00Z", "command": "implement"},
          {"state": "ARCHIVED", "at": "2025-01-20T11:30:00Z", "command": "finish"}
        ],
        "branch": null,
        "archived": true,
        "keep": false
      }
    }
  ]
}
